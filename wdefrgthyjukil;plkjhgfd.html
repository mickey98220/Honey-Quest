<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prince & Princess Rescue: Honey Quest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- General Styles (from both files, merged and adapted) --- */
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* Prioritize Press Start 2P for game-like elements, Inter for general UI */
            font-family: 'Press Start 2P', cursive, 'Inter', sans-serif;
        }

        body {
            background-color: #f0f0f0; /* Default light mode background */
            color: #1a202c; /* Default light mode text color */
            overflow: hidden; /* Prevent scrolling */
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body.dark-mode {
            background-color: #1a202c; /* Dark mode background */
            color: #e2e8f0; /* Dark mode text color */
        }

        /* --- Game Container & Canvas (from Bee and Honey, adapted) --- */
        #game-container {
            position: relative;
            width: 800px; /* Fixed width for game area */
            height: 600px; /* Fixed height for game area */
            background: linear-gradient(#87CEEB, #E0F7FA); /* Default sky background */
            border: 8px solid #4a2c12;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            /* Ensure canvas is responsive within its container */
            max-width: 90%;
            max-height: 90vh;
            aspect-ratio: 4 / 3; /* Maintain aspect ratio */
        }

        #gameCanvas { /* Renamed from #game-canvas to match previous immersive */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block; /* Ensure it takes up space */
        }

        /* --- UI Navigation Bar (from Bee and Honey, adapted) --- */
        #ui-nav {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 20;
            font-family: 'Inter', sans-serif; /* Use Inter for nav for better readability */
        }

        #ui-nav button {
            background: transparent;
            border: none;
            color: #FFD700;
            font-size: 12px;
            cursor: pointer;
            padding: 5px 10px;
            transition: all 0.3s;
            font-family: 'Inter', sans-serif;
        }

        #ui-nav button:hover {
            color: #FFA500;
            transform: scale(1.05);
        }

        #ui-nav button:active {
            transform: scale(0.95);
        }

        #nav-right {
            display: flex;
            gap: 15px;
        }

        #coin-display {
            color: #FFD700;
            font-size: 12px;
            display: flex;
            align-items: center;
            font-family: 'Press Start 2P', cursive; /* Keep retro font for scores */
        }

        #coin-display img {
            width: 16px;
            height: 16px;
            margin-right: 5px;
        }

        /* --- Screens (from both files, merged and adapted) --- */
        #ui-overlay { /* Main UI overlay for non-game screens */
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.8); /* Dark overlay */
            transition: background-color 0.3s ease;
            z-index: 10;
        }

        #homepage-screen, #game-over-screen, #level-complete-screen, #leaderboard-screen, #shop-screen, #settings-screen, #inventory-screen, #levels-screen, #daily-challenges-screen, #customize-screen {
            display: none; /* Managed by JS showScreen function */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            width: 500px; /* Default width for UI screens */
            background-color: #fff; /* Light mode background */
            color: #1a202c; /* Light mode text */
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body.dark-mode #homepage-screen,
        body.dark-mode #game-over-screen,
        body.dark-mode #level-complete-screen,
        body.dark-mode #leaderboard-screen,
        body.dark-mode #shop-screen,
        body.dark-mode #settings-screen,
        body.dark-mode #inventory-screen,
        body.dark-mode #levels-screen,
        body.dark-mode #daily-challenges-screen,
        body.dark-mode #customize-screen {
            background-color: #2d3748; /* Dark mode background */
            color: #e2e8f0; /* Dark mode text */
        }

        h1 {
            color: #FFD700;
            font-size: 36px;
            margin-bottom: 30px;
            text-shadow: 4px 4px 0 #8B4513, 8px 8px 0 #000;
            text-align: center;
            animation: pulse 1.5s infinite alternate;
            font-family: 'Press Start 2P', cursive;
        }

        h2 {
            color: #FFA500;
            font-size: 24px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0 #8B4513;
            font-family: 'Press Start 2P', cursive;
        }

        /* --- Buttons (from both files, merged and adapted) --- */
        .btn { /* Tailwind-based button styling */
            @apply px-6 py-3 rounded-xl font-semibold text-lg transition-all duration-300 ease-in-out transform hover:scale-105 active:scale-95 shadow-lg;
            font-family: 'Inter', sans-serif; /* Use Inter for UI buttons */
        }

        .btn-primary {
            @apply bg-blue-600 text-white hover:bg-blue-700;
        }

        .btn-secondary {
            @apply bg-gray-300 text-gray-800 hover:bg-gray-400;
        }

        body.dark-mode .btn-secondary {
            @apply bg-gray-700 text-gray-100 hover:bg-gray-600;
        }

        /* Original game buttons (for start/restart etc. within the game style) */
        button:not(.btn) { /* Apply to buttons not using .btn class */
            background: linear-gradient(#FFD700, #FFA500);
            border: 4px solid #8B4513;
            color: #4a2c12;
            padding: 15px 30px;
            font-size: 18px;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 10px;
            box-shadow: 0 5px 0 #8B4513;
            font-family: 'Press Start 2P', cursive; /* Keep retro font for game buttons */
        }

        button:not(.btn):hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 0 #8B4513;
        }

        button:not(.btn):active {
            transform: translateY(2px);
            box-shadow: 0 3px 0 #8B4513;
        }

        /* --- Game Info Display (from Bee and Honey) --- */
        #game-info {
            position: absolute;
            top: 50px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 5;
        }

        #score-display, #lives-display, #time-display, #level-display {
            color: #FFD700;
            font-size: 16px;
            text-shadow: 2px 2px 0 #000;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
            border: 2px solid #8B4513;
            font-family: 'Press Start 2P', cursive;
        }

        /* --- Leaderboard Styles (from Bee and Honey) --- */
        #leaderboard {
            width: 80%;
            max-height: 200px;
            overflow-y: auto;
            margin: 20px 0;
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border: 3px solid #FFD700;
            border-radius: 5px;
        }

        #leaderboard table {
            width: 100%;
            border-collapse: collapse;
        }

        #leaderboard th, #leaderboard td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid #FFD700;
            font-size: 12px;
            font-family: 'Press Start 2P', cursive;
        }

        #leaderboard th {
            color: #FFA500;
        }

        #leaderboard tr:nth-child(even) {
            background: rgba(255, 215, 0, 0.1);
        }

        #leaderboard tr:hover {
            background: rgba(255, 215, 0, 0.2);
        }

        /* --- Shop/Inventory Items (from both files, merged and adapted) --- */
        #shop-items, #inventory-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Responsive grid */
            gap: 20px;
            margin: 20px 0;
            width: 100%;
            max-width: 800px;
        }

        .shop-item, .inventory-item { /* Unified styling */
            background-color: #f0f0f0; /* Light mode */
            border: 3px solid #8B4513;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            min-height: 180px; /* Ensure consistent height */
        }

        body.dark-mode .shop-item, body.dark-mode .inventory-item {
            background-color: #4a5568; /* Dark mode */
            border-color: #a0aec0;
        }

        .shop-item:hover, .inventory-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        .shop-item .icon, .inventory-item .icon { /* For Font Awesome icons */
            font-size: 3rem; /* Larger icons */
            margin-bottom: 0.5rem;
        }

        .shop-item img { /* For SVG images */
            width: 50px;
            height: 50px;
            margin-bottom: 10px;
        }

        .shop-item h3, .inventory-item h3 {
            color: #FFD700;
            font-size: 16px;
            margin-bottom: 8px;
            font-family: 'Press Start 2P', cursive;
        }

        .shop-item p, .inventory-item p {
            color: #FFF;
            font-size: 10px;
            margin-bottom: 10px;
            flex-grow: 1; /* Allow description to take space */
        }

        .shop-item .price {
            color: #FFD700;
            font-size: 14px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Press Start 2P', cursive;
        }

        .shop-item .price img {
            width: 16px;
            height: 16px;
            margin: 0 5px;
        }

        .shop-item button, .inventory-item button {
            padding: 8px 15px;
            font-size: 12px;
            margin-top: auto; /* Push button to bottom */
            font-family: 'Inter', sans-serif; /* Use Inter for shop/inventory buttons */
        }

        /* --- Settings Styles (from both files, merged and adapted) --- */
        #settings-options {
            width: 80%;
            max-width: 500px;
            background-color: #f0f0f0; /* Light mode */
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #FFD700;
            font-family: 'Inter', sans-serif;
        }

        body.dark-mode #settings-options {
            background-color: #4a5568; /* Dark mode */
            border-color: #a0aec0;
        }

        .setting-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .setting-option label {
            color: #1a202c; /* Light mode */
            font-size: 14px;
        }

        body.dark-mode .setting-option label {
            color: #e2e8f0; /* Dark mode */
        }

        .setting-option select, .setting-option input[type="range"] {
            background: #cbd5e0; /* Light mode */
            color: #1a202c;
            border: 2px solid #a0aec0;
            padding: 5px;
            border-radius: 5px;
        }

        body.dark-mode .setting-option select, body.dark-mode .setting-option input[type="range"] {
            background: #616e7f; /* Dark mode */
            color: #e2e8f0;
            border-color: #718096;
        }

        /* Custom slider styles (from my previous code) */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #d1d5db; /* Light gray track */
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
            border-radius: 5px;
        }

        input[type="range"]:hover {
            opacity: 1;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4299e1; /* Blue thumb */
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #4299e1; /* Blue thumb */
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Dark mode toggle switch (from my previous code) */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }

        /* Rounded sliders */
        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        /* --- Difficulty Indicator (from Bee and Honey) --- */
        #difficulty-indicator {
            position: absolute;
            top: 50px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
            border: 2px solid #8B4513;
            color: #FFD700;
            font-size: 12px;
            z-index: 5;
            font-family: 'Press Start 2P', cursive;
        }

        /* --- Power-up Indicator (from Bee and Honey) --- */
        #powerup-indicator {
            position: absolute;
            top: 50px;
            left: 20px;
            display: flex;
            gap: 10px;
            z-index: 5;
        }

        .powerup-icon {
            width: 30px;
            height: 30px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            border: 2px solid #FFD700;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #FFD700;
            font-family: 'Inter', sans-serif; /* Use Inter for powerup text */
        }

        /* --- Modal (from my previous code) --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            width: 400px;
        }

        body.dark-mode .modal-content {
            background-color: #2d3748;
            color: #e2e8f0;
        }

        /* --- Animations (from Bee and Honey) --- */
        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .bounce {
            animation: bounce 1s infinite;
        }

        .hidden {
            display: none !important;
        }

        /* Customization preview canvas */
        #player-preview-canvas {
            border: 2px solid #8B4513;
            border-radius: 5px;
            background-color: #E0F7FA;
        }
    </style>
</head>
<body class="light-mode">
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>

        <div id="ui-nav">
            <button id="menu-button-nav">Menu</button>
            <div id="nav-right">
                <div id="coin-display">
                    <i class="fas fa-honey-pot text-amber-600"></i>
                    <span id="coins-count">0</span>
                </div>
                <button id="shop-button-nav">Shop</button>
                <button id="settings-button-nav">Settings</button>
            </div>
        </div>

        <div id="game-info">
            <div id="score-display">Score: 0</div>
            <div id="level-display">Level: 1</div>
            <div id="time-display">Time: 120</div>
            <div id="lives-display">Lives: 3</div>
        </div>

        <div id="powerup-indicator"></div>

        <div id="difficulty-indicator">Difficulty: Normal</div>

        <div id="ui-overlay" class="absolute inset-0 flex items-center justify-center bg-gray-100 dark:bg-gray-800 transition-colors duration-300 z-10">

            <div id="homepage-screen" class="bg-white dark:bg-gray-700 p-8 rounded-2xl shadow-2xl text-center max-w-md w-full transition-all duration-300 transform scale-100 opacity-100">
                <h1 class="text-5xl font-bold text-blue-600 dark:text-blue-400 mb-6 drop-shadow-lg">Prince & Princess Rescue</h1>
                <p class="text-gray-700 dark:text-gray-300 text-lg mb-8" style="font-family: 'Inter', sans-serif;">Embark on a heroic journey to save your beloved princess!</p>

                <div class="space-y-4">
                    <button id="start-game-btn" class="btn btn-primary w-full flex items-center justify-center space-x-2">
                        <i class="fas fa-play"></i> <span>Play Game</span>
                    </button>
                    <button id="levels-btn" class="btn btn-secondary w-full flex items-center justify-center space-x-2">
                        <i class="fas fa-map"></i> <span>Levels</span>
                    </button>
                    <button id="customize-btn" class="btn btn-secondary w-full flex items-center justify-content-center space-x-2">
                        <i class="fas fa-hat-wizard"></i> <span>Customize</span>
                    </button>
                    <button id="shop-btn" class="btn btn-secondary w-full flex items-center justify-center space-x-2">
                        <i class="fas fa-store"></i> <span>Shop</span>
                    </button>
                    <button id="inventory-btn" class="btn btn-secondary w-full flex items-center justify-center space-x-2">
                        <i class="fas fa-box"></i> <span>Inventory</span>
                    </button>
                    <button id="daily-challenges-btn" class="btn btn-secondary w-full flex items-center justify-center space-x-2">
                        <i class="fas fa-calendar-alt"></i> <span>Daily Challenges</span>
                    </button>
                    <button id="settings-btn" class="btn btn-secondary w-full flex items-center justify-center space-x-2">
                        <i class="fas fa-cog"></i> <span>Settings</span>
                    </button>
                    <button id="leaderboard-button" class="btn btn-secondary w-full flex items-center justify-center space-x-2">
                        <i class="fas fa-trophy"></i> <span>Leaderboard</span>
                    </button>
                </div>
            </div>

            <div id="shop-screen" class="hidden bg-white dark:bg-gray-700 p-8 rounded-2xl shadow-2xl max-w-2xl w-full">
                <h2 class="text-4xl font-bold text-blue-600 dark:text-blue-400 mb-6 text-center">Honey Shop</h2>
                <div class="flex justify-between items-center mb-6 text-gray-800 dark:text-gray-200 text-xl font-semibold" style="font-family: 'Inter', sans-serif;">
                    <span>Your Honey Jars: <span id="shop-coins-count">0</span> <i class="fas fa-honey-pot text-amber-600"></i></span>
                </div>
                <div id="shop-items" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    </div>
                <button id="shop-back-btn" class="btn btn-secondary w-full">Back to Home</button>
            </div>

            <div id="inventory-screen" class="hidden bg-white dark:bg-gray-700 p-8 rounded-2xl shadow-2xl max-w-2xl w-full">
                <h2 class="text-4xl font-bold text-blue-600 dark:text-blue-400 mb-6 text-center">Inventory</h2>
                <div id="inventory-items" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    </div>
                <button id="inventory-back-btn" class="btn btn-secondary w-full">Back to Home</button>
            </div>

            <div id="levels-screen" class="hidden bg-white dark:bg-gray-700 p-8 rounded-2xl shadow-2xl max-w-2xl w-full">
                <h2 class="text-4xl font-bold text-blue-600 dark:text-blue-400 mb-6 text-center">Levels</h2>
                <div class="text-gray-700 dark:text-gray-300 text-center mb-8" style="font-family: 'Inter', sans-serif;">
                    <p>Unlock new challenges and explore different worlds!</p>
                    <div class="mt-4 space-y-3" id="level-selection-buttons">
                        </div>
                </div>
                <button id="levels-back-btn" class="btn btn-secondary w-full">Back to Home</button>
            </div>

            <div id="daily-challenges-screen" class="hidden bg-white dark:bg-gray-700 p-8 rounded-2xl shadow-2xl max-w-2xl w-full">
                <h2 class="text-4xl font-bold text-blue-600 dark:text-blue-400 mb-6 text-center">Daily Challenges</h2>
                <div class="text-gray-700 dark:text-gray-300 text-center mb-8" style="font-family: 'Inter', sans-serif;">
                    <p>Complete these challenges for bonus rewards!</p>
                    <div class="mt-4 space-y-3">
                        <div class="p-4 bg-gray-100 dark:bg-gray-600 rounded-lg shadow flex items-center justify-between">
                            <span class="font-semibold text-lg">Collect 50 Coins</span>
                            <span class="text-yellow-500">Progress: 30/50</span>
                        </div>
                        <div class="p-4 bg-gray-100 dark:bg-gray-600 rounded-lg shadow flex items-center justify-between">
                            <span class="font-semibold text-lg">Find 3 Honey Jars</span>
                            <span class="text-green-500">Completed <i class="fas fa-check-circle"></i></span>
                        </div>
                        <div class="p-4 bg-gray-100 dark:bg-gray-600 rounded-lg shadow flex items-center justify-between">
                            <span class="font-semibold text-lg">Reach Princess in 60s</span>
                            <span class="text-red-500">Failed</span>
                        </div>
                    </div>
                </div>
                <button id="daily-challenges-back-btn" class="btn btn-secondary w-full">Back to Home</button>
            </div>

            <div id="customize-screen" class="hidden bg-white dark:bg-gray-700 p-8 rounded-2xl shadow-2xl max-w-2xl w-full">
                <h2 class="text-4xl font-bold text-blue-600 dark:text-blue-400 mb-6 text-center">Customize Prince</h2>
                <div class="flex justify-between items-center mb-6 text-gray-800 dark:text-gray-200 text-xl font-semibold" style="font-family: 'Inter', sans-serif;">
                    <span>Your Honey Jars: <span id="customize-coins-count">0</span> <i class="fas fa-honey-pot text-amber-600"></i></span>
                </div>
                <div class="flex flex-col items-center mb-8">
                    <canvas id="player-preview-canvas" width="120" height="180"></canvas>
                    <p class="text-gray-700 dark:text-gray-300 text-sm mt-2">Preview</p>
                </div>

                <div class="space-y-6 w-full">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Skin Color:</h3>
                        <div id="skin-color-options" class="flex justify-center space-x-3">
                            </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Outfit Color:</h3>
                        <div id="outfit-color-options" class="flex justify-center space-x-3">
                            </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-semibold text-gray-800 dark:text-gray-200">Royal Crown (10 <i class="fas fa-honey-pot text-amber-600"></i>):</span>
                        <button id="buy-crown-btn" class="btn btn-primary text-sm py-2 px-4">Buy</button>
                        <span id="crown-status" class="text-green-500 font-bold hidden">OWNED</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-semibold text-gray-800 dark:text-gray-200">Bee Wings (15 <i class="fas fa-honey-pot text-amber-600"></i>):</span>
                        <button id="buy-wings-btn" class="btn btn-primary text-sm py-2 px-4">Buy</button>
                        <span id="wings-status" class="text-green-500 font-bold hidden">OWNED</span>
                    </div>
                </div>
                <button id="customize-back-btn" class="btn btn-secondary w-full mt-8">Save & Back</button>
            </div>


            <div id="settings-screen" class="hidden bg-white dark:bg-gray-700 p-8 rounded-2xl shadow-2xl max-w-md w-full">
                <h2 class="text-4xl font-bold text-blue-600 dark:text-blue-400 mb-6 text-center">Settings</h2>
                <div id="settings-options" class="w-full max-w-none bg-transparent border-none p-0">
                    <div class="setting-option">
                        <label for="difficulty">Difficulty:</label>
                        <select id="difficulty">
                            <option value="easy">Easy</option>
                            <option value="normal" selected>Normal</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>
                    <div class="setting-option">
                        <label for="volume-slider" class="block text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">Music Volume</label>
                        <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.5" class="w-full">
                    </div>
                    <div class="setting-option">
                        <label for="sfx-volume-slider" class="block text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">Sound Effects Volume</label>
                        <input type="range" id="sfx-volume-slider" min="0" max="1" step="0.01" value="0.7" class="w-full">
                    </div>
                    <div class="setting-option">
                        <label for="sound">Sound Effects:</label>
                        <select id="sound">
                            <option value="on">On</option>
                            <option value="off">Off</option>
                        </select>
                    </div>
                    <div class="setting-option">
                        <label for="controls">Controls:</label>
                        <select id="controls">
                            <option value="arrows" selected>Arrow Keys</option>
                            <option value="wasd">WASD</option>
                        </select>
                    </div>
                    <div class="flex items-center justify-between mt-4">
                        <span class="text-lg font-semibold text-gray-700 dark:text-gray-300">Dark Mode</span>
                        <label class="switch relative inline-block w-14 h-8">
                            <input type="checkbox" id="dark-mode-toggle" class="opacity-0 w-0 h-0">
                            <span class="slider round absolute cursor-pointer top-0 left-0 right-0 bottom-0 bg-gray-300 dark:bg-gray-600 rounded-full transition-colors duration-300 before:absolute before:content-[''] before:h-6 before:w-6 before:left-1 before:bottom-1 before:bg-white before:rounded-full before:transition-transform before:duration-300 before:shadow"></span>
                        </label>
                    </div>
                </div>
                <button id="settings-back-btn" class="btn btn-secondary w-full mt-8">Back to Home</button>
            </div>

            <div id="game-over-screen" class="hidden">
                <h1>GAME OVER</h1>
                <h2 id="final-score">Score: 0</h2>
                <h3 id="coins-earned">+0 Honey Jars</h3>
                <button id="restart-button">Play Again</button>
                <button id="menu-button">Main Menu</button>
            </div>

            <div id="level-complete-screen" class="hidden">
                <h1>LEVEL COMPLETE!</h1>
                <h2 id="level-score">Score: 0</h2>
                <h3 id="level-coins">+0 Honey Jars</h3>
                <button id="next-level-button">Next Level</button>
                <button id="menu-level-button">Main Menu</button>
            </div>

            <div id="leaderboard-screen" class="hidden">
                <h1>LEADERBOARD</h1>
                <div id="leaderboard">
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Name</th>
                                <th>Score</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body">
                            </tbody>
                    </table>
                </div>
                <button id="back-button">Back to Menu</button>
            </div>

        </div>

        <div id="message-box" class="modal hidden">
            <div class="modal-content">
                <p id="message-box-text" class="text-xl font-semibold mb-6"></p>
                <div id="message-box-buttons" class="flex justify-center space-x-4">
                    <button id="message-box-ok" class="btn btn-primary px-6 py-2">OK</button>
                    <button id="message-box-cancel" class="btn btn-secondary px-6 py-2 hidden">Cancel</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- Game State and UI Management ---
        const gameState = {
            currentScreen: 'homepage', // homepage, game, shop, inventory, settings, levels, dailyChallenges, gameOver, levelComplete, leaderboard, customize
            player: {
                x: 50,
                y: 500, /* Adjusted for ground level */
                width: 40, /* Adjusted for image */
                height: 60, /* Adjusted for image */
                speed: 5, /* Base speed */
                jumpForce: 12,
                velocityY: 0,
                isJumping: false,
                direction: 'right',
                frame: 0,
                frameCount: 0,
                baseSpeed: 5,
                // Customization properties
                skinColor: '#FFD700', // Gold
                outfitColor: '#8B4513', // Brown
                hasCrown: false,
                hasWings: false,
            },
            princess: { /* Renamed from honeyQueen for clarity in main game logic */
                x: 700,
                y: 480, /* Adjusted for ground level */
                width: 40,
                height: 60,
                saved: false
            },
            coins: [], // These are the gold coins in game
            honeyJars: [], // These are the honey jars that act as currency
            score: 0,
            lives: 3,
            timeLeft: 120,
            inventory: {
                'health-potion': 0,
                'speed-boost': 0,
                'extra-life': 0,
                'time-bonus': 0,
                'invincibility': 0,
                'fancy-hat': 0,
                'shiny-sword': 0
            },
            shopItems: [
                { id: 'speed-boost', name: 'Speed Boost', type: 'consumable', cost: 5, currency: 'honeyJars', effect: 'Increase movement speed for 30 seconds', icon: '<i class="fas fa-running text-green-500"></i>', image: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iI0ZGRDcwMCIgZD0iTTEyLDJMMTUsNkgxOVYxMEwyMiwxMkwxOCwxMkwxNSwxNUwxMiwxMkw4LDEyTDExLDlMNyw2TDExLDJIMTJNMTIsMTNMMTUsMTZIMTlWMjBMMjIsMjJMMTgsMjJMMTUsMTlMMTIsMjJMNiwyMkw5LDE5TDUsMTZMOSwxM0wxMiwxM3oiLz48L3N2Z3Q=' },
                { id: 'extra-life', name: 'Extra Life', type: 'consumable', cost: 10, currency: 'honeyJars', effect: 'Gain an additional life', icon: '<i class="fas fa-heart text-pink-500"></i>', image: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iI0ZGRDcwMCIgZD0iTTEyLDE3QTIsMiAwIDAsMCAxNCwxNUgxMkExLDQgMCAwLDEgMTMsMTNaTTUsMTVWMjJIMTlWMTVIMTdWMTdBNyw3IDAgMCwxIDUsMTdaTTE3LDExQTUsNSAwIDAsMCA3LDExVjVIMTdWMTFNMTcsM0g1QTIsMiAwIDAsMSA3LDFIMTdBMSwxIDAgMCAxIDE4LDJWMThBMSwxIDAgMCwxIDE3LDE5SDE1VjIxQTIsMiAwIDAsMSAxMywyM0gxMUEyLDIgMCAwLDEgOSwyMVYxOUg3QTIsMiAwIDAsMSA1LDE3VjNBMSwxIDAgMCwxIDYsMkg0QTEsMSAwIDAsMSA1LDFIMTdBMywzIDAgMCwxIDIwLDRWMThBMywzIDAgMCwxIDE3LDIxSDE1VjE5SDE3QTIsMiAwIDAsMSA1LDE3VjMBeTIsMiAwIDAsMSAxNywzWiIvPjwvc3ZnPg==' },
                { id: 'time-bonus', name: 'Time Bonus', type: 'consumable', cost: 7, currency: 'honeyJars', effect: 'Add 30 seconds to the clock', icon: '<i class="fas fa-hourglass-half text-blue-500"></i>', image: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iI0ZGRDcwMCIgZD0iTTEyLDJBMTAsMTAgMCAwLDAgMiwxMkExMCwxMCAwIDAsMCAxMiwyMkExMCwxMCAwIDAsMCAyMiwxMkExMCwxMCAwIDAsMCAxMiwyTTEyLDRBOCw4IDAgMCwxIDIwLDEyQTgsOCAwIDAsMSAxMiwyMEE4LDggMCAwLDEgNCwxMkE4LDggMCAwLDEgMTIsNFYyMEE4LDggMCAwLDAgMjAsMTJBOCw4IDAgMCwwIDEyLDRaIi8+PC9zdmc+' },
                { id: 'invincibility', name: 'Invincibility', type: 'consumable', cost: 15, currency: 'honeyJars', effect: 'Become invincible for 15 seconds', icon: '<i class="fas fa-shield-alt text-yellow-500"></i>', image: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCI+PHBhdGggZmlsbD0iI0ZGRDcwMCIgZD0iTTEyLDJBMTAsMTAgMCAwLDAgMiwxMkExMCwxMCAwIDAsMCAxMiwyMkExMCwxMCAwIDAsMCAyMiwxMkExMCwxMCAwIDAsMCAxMiwyTTEyLDhBNCw0IDAgMCwxIDE2LDEyQTQsNCAwIDAsMSAxMiwxNkE0LDQgMCAwLDEgOCwxMkE0LDQgMCAwLDEgMTIsOFoiLS8+PC9zdmc+' },
                { id: 'fancy-hat', name: 'Fancy Hat', type: 'customization', cost: 25, currency: 'honeyJars', effect: 'Makes you look dashing (placeholder)', icon: '<i class="fas fa-hat-wizard text-purple-500"></i>', image: '' },
                { id: 'shiny-sword', name: 'Shiny Sword', type: 'customization', cost: 40, currency: 'honeyJars', effect: 'Looks cool (placeholder)', icon: '<i class="fas fa-sword text-gray-500"></i>', image: '' }
            ],
            skinColors: ['#FFD700', '#FFA500', '#FFEB3B'], // Gold, Orange, Yellow
            outfitColors: ['#8B4513', '#654321', '#A0522D'], // SaddleBrown, DarkBrown, Sienna
            settings: {
                musicVolume: 0.5,
                sfxVolume: 0.7,
                darkMode: false,
                difficulty: 'normal',
                controls: 'arrows',
                soundEnabled: true // Added soundEnabled to settings
            },
            keys: {
                ArrowLeft: false, ArrowRight: false, ArrowUp: false, ArrowDown: false,
                a: false, d: false, w: false, s: false,
                ' ': false // Spacebar for jump
            },
            audio: {
                backgroundMusic: null,
                coinSound: null,
                jumpSound: null,
                winSound: null, /* Used for level complete */
                buttonClick: null,
                stompSound: null, /* For enemy stomp */
                hurtSound: null /* For player getting hurt */
            },
            gameRunning: false, // Flag to control game loop
            animationFrameId: null, // To store the requestAnimationFrame ID
            gameTimeInterval: null,
            currentLevel: 1,
            maxLevel: 3, // New: Maximum number of levels
            playerUpgrades: {
                speed: false,
                speedEndTime: 0,
                invincible: false,
                invincibleEndTime: 0
            },
            // Game objects for current level
            ground: { y: 550, height: 50, color: '#8B4513' },
            platforms: [],
            enemies: [],
            tunnels: [],
            tunnelExits: [], // Stores exit coordinates for tunnels
            particles: [],
            flag: null,
            backgroundElements: [],
            clouds: [],
            // Transition variables
            transitionAlpha: 0,
            transitionState: 0, // 0: inactive, 1: fade out, 2: fade in
            transitionTargetPos: { x: 0, y: 0 }, // Where player will be teleported after fade out
            transitionTargetLevel: 1, // Which level to load after fade out
        };

        // Global variable for the dynamically generated player image
        let playerImageInstance;

        // --- DOM Elements (Declared here but assigned inside window.onload) ---
        let uiOverlay, homepageScreen, gameScreen, shopScreen, inventoryScreen, settingsScreen,
            levelsScreen, dailyChallengesScreen, gameOverScreen, levelCompleteScreen, leaderboardScreen, customizeScreen;

        let startGameBtn, shopBtn, inventoryBtn, levelsBtn, dailyChallengesBtn, settingsBtn, leaderboardButton, customizeBtn;
        let shopBackBtn, inventoryBackBtn, levelsBackBtn, dailyChallengesBackBtn, settingsBackBtn, customizeBackBtn,
            restartButton, menuButton, nextLevelButton, menuLevelButton, backButton;
        let levelSelectionButtonsDiv; // For dynamically adding level buttons
        let playLevelButtons = {}; // Store references to individual level play buttons

        let menuButtonNav, shopButtonNav, settingsButtonNav;

        let scoreDisplay, livesDisplay, timeDisplay, levelDisplay, finalScore, levelScore,
            coinsEarned, levelCoins, leaderboardBody, coinsCount, shopCoinsCount, customizeCoinsCount,
            difficultyIndicator, powerupIndicator;

        let shopItemsDiv, inventoryItemsDiv;

        let volumeSlider, sfxVolumeSlider, darkModeToggle, difficultySelect, soundSelect, controlsSelect;

        let playerPreviewCanvas, playerPreviewCtx;
        let skinColorOptionsDiv, outfitColorOptionsDiv, buyCrownBtn, buyWingsBtn, crownStatusSpan, wingsStatusSpan;

        let messageBox, messageBoxText, messageBoxOkBtn, messageBoxCancelBtn;

        // --- Game Canvas Setup ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Adjust canvas size for responsiveness
        function resizeCanvas() {
            // Set a base aspect ratio (e.g., 4:3 from Bee and Honey)
            const aspectRatio = 4 / 3;
            const maxWidth = window.innerWidth * 0.9; // Max 90% of window width
            const maxHeight = window.innerHeight * 0.8; // Max 80% of window height

            let newWidth = maxWidth;
            let newHeight = newWidth / aspectRatio;

            if (newHeight > maxHeight) {
                newHeight = maxHeight;
                newWidth = newHeight * aspectRatio;
            }

            canvas.width = newWidth;
            canvas.height = newHeight;

            // Re-render game elements if game is running
            if (gameState.gameRunning) {
                drawGame();
            }
        }

        window.addEventListener('resize', resizeCanvas);
        // Initial resize
        resizeCanvas();

        // --- Audio Management (merged and adapted) ---
        function loadAudio() {
            // Background music (from my previous code)
            gameState.audio.backgroundMusic = new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3');
            gameState.audio.backgroundMusic.loop = true;
            gameState.audio.backgroundMusic.volume = gameState.settings.musicVolume;

            // SFX (from Bee and Honey, using base64 audio placeholders)
            // In a real game, replace these with actual audio files (e.g., short, optimized WAV/MP3)
            gameState.audio.jumpSound = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA='); // Very short placeholder
            gameState.audio.collectSound = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA='); // Very short placeholder
            gameState.audio.stompSound = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA='); // Very short placeholder
            gameState.audio.hurtSound = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA='); // Very short placeholder
            gameState.audio.winSound = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA='); // Very short placeholder
            gameState.audio.buttonClick = new Audio('https://www.soundhelix.com/examples/mp3/SoundHelix-Song-6.mp3'); // Placeholder SFX for UI clicks

            // Set initial SFX volume
            for (const key in gameState.audio) {
                if (key !== 'backgroundMusic' && gameState.audio[key] instanceof Audio) {
                    gameState.audio[key].volume = gameState.settings.sfxVolume;
                }
            }
        }

        function playSound(sound) {
            if (gameState.audio[sound] && gameState.settings.soundEnabled) {
                gameState.audio[sound].currentTime = 0; // Rewind to start
                gameState.audio[sound].play().catch(e => console.error("Error playing sound:", e));
            }
        }

        function updateVolume() {
            if (gameState.audio.backgroundMusic) {
                gameState.audio.backgroundMusic.volume = gameState.settings.musicVolume;
            }
            for (const key in gameState.audio) {
                if (key !== 'backgroundMusic' && gameState.audio[key] instanceof Audio) {
                    gameState.audio[key].volume = gameState.settings.sfxVolume;
                }
            }
        }

        // --- UI Navigation (merged and adapted) ---
        function showScreen(screenId) {
            const allScreens = [
                homepageScreen, shopScreen, inventoryScreen, settingsScreen,
                levelsScreen, dailyChallengesScreen, gameOverScreen, levelCompleteScreen, leaderboardScreen, customizeScreen
            ];

            allScreens.forEach(screen => {
                if (screen && screen.id === screenId) { // Check if screen element exists
                    screen.classList.remove('hidden');
                    // Add flex for centering if it's a UI screen
                    if (screen.id !== 'gameCanvas') { // gameCanvas is not a flex container
                        screen.classList.add('flex');
                    }
                } else if (screen) { // Check if screen element exists before hiding
                    screen.classList.add('hidden');
                    screen.classList.remove('flex');
                }
            });
            gameState.currentScreen = screenId.replace('-screen', '').replace('Canvas', 'game'); // Update current screen state

            // Manage game loop and music based on screen
            if (gameState.currentScreen === 'game') {
                uiOverlay.classList.add('hidden'); // Hide overlay when game is active
                if (!gameState.gameRunning) {
                    if (gameState.audio.backgroundMusic) {
                        gameState.audio.backgroundMusic.play().catch(e => console.error("Error playing background music:", e));
                    }
                    startGameLoop();
                }
            } else {
                uiOverlay.classList.remove('hidden'); // Show overlay for UI screens
                if (gameState.gameRunning) {
                    cancelAnimationFrame(gameState.animationFrameId);
                    clearInterval(gameState.gameTimeInterval);
                    gameState.gameRunning = false;
                    if (gameState.audio.backgroundMusic) {
                        gameState.audio.backgroundMusic.pause();
                    }
                }
            }

            // Update UI elements specific to each screen
            if (screenId === 'shop-screen') {
                updateShopUI();
            } else if (screenId === 'inventory-screen') {
                updateInventoryUI();
            } else if (screenId === 'leaderboard-screen') {
                renderLeaderboard();
            } else if (screenId === 'levels-screen') {
                renderLevelSelection();
            } else if (screenId === 'customize-screen') {
                updateCustomizeUI();
            }
        }

        // --- Message Box (Custom Alert/Confirm) ---
        function showMessageBox(message, type = 'alert') {
            return new Promise(resolve => {
                messageBoxText.textContent = message;
                messageBoxOkBtn.onclick = () => {
                    messageBox.classList.add('hidden');
                    resolve(true);
                    playSound('buttonClick');
                };
                if (type === 'confirm') {
                    messageBoxCancelBtn.classList.remove('hidden');
                    messageBoxCancelBtn.onclick = () => {
                        messageBox.classList.add('hidden');
                        resolve(false);
                        playSound('buttonClick');
                    };
                } else {
                    messageBoxCancelBtn.classList.add('hidden');
                }
                messageBox.classList.remove('hidden');
            });
        }

        // --- Dark Mode Toggle ---
        function toggleDarkMode() {
            gameState.settings.darkMode = !gameState.settings.darkMode;
            document.body.classList.toggle('dark-mode', gameState.settings.darkMode);
            darkModeToggle.checked = gameState.settings.darkMode;
            // Update settings in local storage
            saveGameState();
        }

        // --- Shop Functions (merged and adapted) ---
        function updateShopUI() {
            shopCoinsCount.textContent = gameState.honeyJars.length; // Honey Jars are the currency
            shopItemsDiv.innerHTML = ''; // Clear previous items

            gameState.shopItems.forEach(item => {
                const itemCard = document.createElement('div');
                itemCard.className = 'shop-item'; // Use combined shop-item class
                item.image = item.image || ''; // Ensure image property exists
                itemCard.innerHTML = `
                    <div class="icon">${item.icon || (item.image ? `<img src="${item.image}" alt="${item.name}">` : '')}</div>
                    <h3>${item.name}</h3>
                    <p>${item.effect}</p>
                    <div class="price">${item.cost} <i class="fas fa-honey-pot text-amber-600"></i></div>
                    <button class="buy-btn btn btn-primary px-4 py-2 text-sm w-full" data-item-id="${item.id}">Buy</button>
                `;
                shopItemsDiv.appendChild(itemCard);
            });

            document.querySelectorAll('.buy-btn').forEach(button => {
                button.onclick = (event) => {
                    playSound('buttonClick');
                    const itemId = event.target.dataset.itemId;
                    buyItem(itemId);
                };
            });
        }

        async function buyItem(itemId) {
            const item = gameState.shopItems.find(i => i.id === itemId);
            if (!item) return;

            if (gameState.honeyJars.length >= item.cost) {
                const confirmBuy = await showMessageBox(`Do you want to buy ${item.name} for ${item.cost} Honey Jars?`, 'confirm');
                if (confirmBuy) {
                    // Deduct honey jars (remove from array)
                    for (let i = 0; i < item.cost; i++) {
                        gameState.honeyJars.pop(); // Simply remove from end for now
                    }
                    gameState.inventory[item.id] = (gameState.inventory[item.id] || 0) + 1;
                    updateShopUI();
                    updateGameUI(); // Update in-game honey jar count
                    showMessageBox(`${item.name} purchased!`);
                    saveGameState(); // Save state after purchase
                }
            } else {
                showMessageBox(`Not enough Honey Jars to buy ${item.name}.`);
            }
        }

        // --- Inventory Functions (from my previous code) ---
        function updateInventoryUI() {
            inventoryItemsDiv.innerHTML = ''; // Clear previous items

            let hasItems = false;
            for (const itemId in gameState.inventory) {
                const quantity = gameState.inventory[itemId];
                if (quantity > 0) {
                    hasItems = true;
                    const item = gameState.shopItems.find(i => i.id === itemId); // Re-use shopItems for item details
                    if (item) {
                        const itemCard = document.createElement('div');
                        itemCard.className = 'inventory-item'; // Use combined inventory-item class
                        item.image = item.image || ''; // Ensure image property exists
                        itemCard.innerHTML = `
                            <div class="icon">${item.icon || (item.image ? `<img src="${item.image}" alt="${item.name}">` : '')}</div>
                            <h3>${item.name}</h3>
                            <p>Quantity: ${quantity}</p>
                            <button class="use-btn btn btn-primary px-4 py-2 text-sm w-full ${item.type === 'customization' ? 'hidden' : ''}" data-item-id="${item.id}">Use</button>
                            ${item.type === 'customization' ? '<button class="equip-btn btn btn-secondary px-4 py-2 text-sm w-full" data-item-id="${item.id}">Equip (placeholder)</button>' : ''}
                        `;
                        inventoryItemsDiv.appendChild(itemCard);
                    }
                }
            }

            if (!hasItems) {
                inventoryItemsDiv.innerHTML = '<p class="text-center text-gray-600 dark:text-gray-300 text-lg" style="font-family: \'Inter\', sans-serif;">Your inventory is empty.</p>';
            }

            document.querySelectorAll('.use-btn').forEach(button => {
                button.onclick = (event) => {
                    playSound('buttonClick');
                    const itemId = event.target.dataset.itemId;
                    useConsumable(itemId);
                };
            });
            document.querySelectorAll('.equip-btn').forEach(button => {
                button.onclick = (event) => {
                    playSound('buttonClick');
                    const itemId = event.target.dataset.itemId;
                    showMessageBox(`You equipped the ${itemId}! (Effect placeholder)`);
                    // TODO: Implement actual equipping logic
                };
            });
        }

        async function useConsumable(itemId) {
            if (gameState.inventory[itemId] > 0) {
                const item = gameState.shopItems.find(i => i.id === itemId);
                if (item && item.type === 'consumable') {
                    const confirmUse = await showMessageBox(`Do you want to use ${item.name}?`, 'confirm');
                    if (confirmUse) {
                        gameState.inventory[itemId]--;
                        showMessageBox(`Used ${item.name}! (Effect applied: ${item.effect})`);
                        updateInventoryUI();
                        applyConsumableEffect(itemId);
                        saveGameState(); // Save state after use
                    }
                }
            } else {
                showMessageBox(`You don't have any ${item.name} left.`);
            }
        }

        function applyConsumableEffect(itemId) {
            switch (itemId) {
                case 'speed-boost':
                    gameState.playerUpgrades.speed = true;
                    gameState.playerUpgrades.speedEndTime = Date.now() + 30000; // 30 seconds
                    break;
                case 'extra-life':
                    gameState.lives++;
                    livesDisplay.textContent = `Lives: ${gameState.lives}`;
                    break;
                case 'time-bonus':
                    gameState.timeLeft += 30;
                    timeDisplay.textContent = `Time: ${gameState.timeLeft}`;
                    break;
                case 'invincibility':
                    gameState.playerUpgrades.invincible = true;
                    gameState.playerUpgrades.invincibleEndTime = Date.now() + 15000; // 15 seconds
                    break;
            }
            updatePowerupIndicator();
        }

        // Function to generate the player image dynamically
        function createPlayerImageBitmap() {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = gameState.player.width;
            tempCanvas.height = gameState.player.height;
            const tempCtx = tempCanvas.getContext('2d');

            const centerX = tempCanvas.width / 2;
            const centerY = tempCanvas.height / 2;

            // Save context state before transformations for drawing player
            tempCtx.save();
            // Translate to the center of the player's bounding box to draw relative to it
            tempCtx.translate(centerX, centerY);

            // Draw player head (approx 1/2 of player width for diameter)
            tempCtx.fillStyle = gameState.player.skinColor;
            tempCtx.beginPath();
            tempCtx.arc(0, -gameState.player.height / 3, gameState.player.width / 4, 0, Math.PI * 2); // Head circle
            tempCtx.fill();

            // Draw player body (approx 1/2 of player width, 2/3 of player height)
            tempCtx.fillStyle = gameState.player.outfitColor;
            tempCtx.fillRect(-gameState.player.width / 4, -gameState.player.height / 3 + (gameState.player.width / 4), gameState.player.width / 2, gameState.player.height * 2 / 3 - (gameState.player.width / 4)); // Body rectangle

            // Draw eyes
            tempCtx.fillStyle = '#000';
            tempCtx.beginPath();
            tempCtx.arc(-gameState.player.width / 8, -gameState.player.height / 3 - 5, 2, 0, Math.PI * 2);
            tempCtx.arc(gameState.player.width / 8, -gameState.player.height / 3 - 5, 2, 0, Math.PI * 2);
            tempCtx.fill();

            // Draw mouth
            tempCtx.strokeStyle = '#000';
            tempCtx.lineWidth = 1;
            tempCtx.beginPath();
            tempCtx.arc(0, -gameState.player.height / 3 + 5, gameState.player.width / 8, 0, Math.PI);
            tempCtx.stroke();

            // Draw crown
            if (gameState.player.hasCrown) {
                tempCtx.fillStyle = '#FFD700'; // Gold
                tempCtx.beginPath();
                tempCtx.moveTo(-gameState.player.width / 4, -gameState.player.height / 2 + 5);
                tempCtx.lineTo(-gameState.player.width / 8, -gameState.player.height / 2 + 0);
                tempCtx.lineTo(0, -gameState.player.height / 2 - 5);
                tempCtx.lineTo(gameState.player.width / 8, -gameState.player.height / 2 + 0);
                tempCtx.lineTo(gameState.player.width / 4, -gameState.player.height / 2 + 5);
                tempCtx.closePath();
                tempCtx.fill();
                tempCtx.beginPath();
                tempCtx.arc(0, -gameState.player.height / 2 - 3, 2, 0, Math.PI * 2); // Crown tip
                tempCtx.fill();
            }

            // Draw wings
            if (gameState.player.hasWings) {
                tempCtx.fillStyle = 'rgba(255, 255, 255, 0.7)'; // Semi-transparent white
                tempCtx.beginPath();
                tempCtx.ellipse(-gameState.player.width / 2 + 5, 0, gameState.player.width / 4, gameState.player.height / 3, -Math.PI / 8, 0, Math.PI * 2); // Left wing
                tempCtx.fill();
                tempCtx.beginPath();
                tempCtx.ellipse(gameState.player.width / 2 - 5, 0, gameState.player.width / 4, gameState.player.height / 3, Math.PI / 8, 0, Math.PI * 2); // Right wing
                tempCtx.fill();
            }
            tempCtx.restore(); // Restore context to original state

            // Return an Image element from the canvas
            const img = new Image();
            img.src = tempCanvas.toDataURL();
            return img;
        }

        // --- Customization Functions ---
        function updateCustomizeUI() {
            customizeCoinsCount.textContent = gameState.honeyJars.length;
            drawCustomPlayerPreview(); // Update preview when UI updates

            // Render skin color options
            skinColorOptionsDiv.innerHTML = '';
            gameState.skinColors.forEach((color, index) => {
                const colorDiv = document.createElement('div');
                colorDiv.className = `w-10 h-10 rounded-full cursor-pointer border-2 ${gameState.player.skinColor === color ? 'border-yellow-500' : 'border-gray-300'}`;
                colorDiv.style.backgroundColor = color;
                colorDiv.onclick = () => {
                    gameState.player.skinColor = color;
                    playerImageInstance = createPlayerImageBitmap(); // Regenerate main game player image
                    updateCustomizeUI(); // Redraw UI and preview
                    saveGameState();
                    playSound('buttonClick');
                };
                skinColorOptionsDiv.appendChild(colorDiv);
            });

            // Render outfit color options
            outfitColorOptionsDiv.innerHTML = '';
            gameState.outfitColors.forEach((color, index) => {
                const colorDiv = document.createElement('div');
                colorDiv.className = `w-10 h-10 rounded-full cursor-pointer border-2 ${gameState.player.outfitColor === color ? 'border-yellow-500' : 'border-gray-300'}`;
                colorDiv.style.backgroundColor = color;
                colorDiv.onclick = () => {
                    gameState.player.outfitColor = color;
                    playerImageInstance = createPlayerImageBitmap(); // Regenerate main game player image
                    updateCustomizeUI(); // Redraw UI and preview
                    saveGameState();
                    playSound('buttonClick');
                };
                outfitColorOptionsDiv.appendChild(colorDiv);
            });

            // Update crown and wings status
            if (gameState.player.hasCrown) {
                buyCrownBtn.classList.add('hidden');
                crownStatusSpan.classList.remove('hidden');
            } else {
                buyCrownBtn.classList.remove('hidden');
                crownStatusSpan.classList.add('hidden');
            }

            if (gameState.player.hasWings) {
                buyWingsBtn.classList.add('hidden');
                wingsStatusSpan.classList.remove('hidden');
            } else {
                buyWingsBtn.classList.remove('hidden');
                wingsStatusSpan.classList.add('hidden');
            }
        }

        async function buyCustomizationItem(itemId) {
            const item = gameState.shopItems.find(i => i.id === itemId);
            if (!item) return;

            if (gameState.honeyJars.length >= item.cost) {
                const confirmBuy = await showMessageBox(`Do you want to buy ${item.name} for ${item.cost} Honey Jars?`, 'confirm');
                if (confirmBuy) {
                    for (let i = 0; i < item.cost; i++) {
                        gameState.honeyJars.pop();
                    }
                    if (itemId === 'fancy-hat') {
                        gameState.player.hasCrown = true;
                    } else if (itemId === 'shiny-sword') { // Re-using shiny-sword for wings as per Java logic
                        gameState.player.hasWings = true;
                    }
                    playerImageInstance = createPlayerImageBitmap(); // Regenerate main game player image
                    updateCustomizeUI();
                    updateGameUI();
                    showMessageBox(`${item.name} purchased!`);
                    saveGameState();
                }
            } else {
                showMessageBox(`Not enough Honey Jars to buy ${item.name}.`);
            }
        }

        function drawCustomPlayerPreview() {
            const previewCtx = playerPreviewCanvas.getContext('2d');
            previewCtx.clearRect(0, 0, playerPreviewCanvas.width, playerPreviewCanvas.height);

            const centerX = playerPreviewCanvas.width / 2;
            const centerY = playerPreviewCanvas.height / 2;

            // Scale factor to fit player in preview
            const scale = 1.5;

            previewCtx.save();
            previewCtx.translate(centerX, centerY + 20); // Center the player vertically and slightly down
            previewCtx.scale(scale, scale);

            // Draw player head (scaled from 40x60 original image size)
            previewCtx.fillStyle = gameState.player.skinColor;
            previewCtx.beginPath();
            previewCtx.arc(0, -30, 20, 0, Math.PI * 2); // Head circle
            previewCtx.fill();

            // Draw player body
            previewCtx.fillStyle = gameState.player.outfitColor;
            previewCtx.fillRect(-15, -10, 30, 40); // Body rectangle

            // Draw eyes
            previewCtx.fillStyle = '#000';
            previewCtx.beginPath();
            previewCtx.arc(-7, -35, 3, 0, Math.PI * 2);
            previewCtx.arc(7, -35, 3, 0, Math.PI * 2);
            previewCtx.fill();

            // Draw mouth
            previewCtx.strokeStyle = '#000';
            previewCtx.lineWidth = 1;
            previewCtx.beginPath();
            previewCtx.arc(0, -25, 8, 0, Math.PI);
            previewCtx.stroke();

            // Draw crown
            if (gameState.player.hasCrown) {
                previewCtx.fillStyle = '#FFD700'; // Gold
                previewCtx.beginPath();
                previewCtx.moveTo(-15, -45);
                previewCtx.lineTo(-10, -55);
                previewCtx.lineTo(0, -60);
                previewCtx.lineTo(10, -55);
                previewCtx.lineTo(15, -45);
                previewCtx.closePath();
                previewCtx.fill();
                previewCtx.beginPath();
                previewCtx.arc(0, -58, 2, 0, Math.PI * 2); // Crown tip
                previewCtx.fill();
            }

            // Draw wings
            if (gameState.player.hasWings) {
                previewCtx.fillStyle = 'rgba(255, 255, 255, 0.7)'; // Semi-transparent white
                previewCtx.beginPath();
                previewCtx.ellipse(-25, 0, 15, 25, -Math.PI / 8, 0, Math.PI * 2); // Left wing
                previewCtx.fill();
                previewCtx.beginPath();
                previewCtx.ellipse(25, 0, 15, 25, Math.PI / 8, 0, Math.PI * 2); // Right wing
                previewCtx.fill();
            }

            previewCtx.restore();
        }

        // --- Game Logic (merged and adapted) ---
        function initGame(level = 1) {
            gameState.score = 0;
            gameState.lives = 3;
            gameState.currentLevel = level;

            // Reset player
            gameState.player.x = 50;
            gameState.player.y = gameState.ground.y - gameState.player.height;
            gameState.player.velocityY = 0;
            gameState.player.isJumping = false;
            gameState.player.direction = 'right';
            gameState.player.speed = gameState.player.baseSpeed;

            // Reset upgrades
            gameState.playerUpgrades = {
                speed: false,
                speedEndTime: 0,
                invincible: false,
                invincibleEndTime: 0
            };
            updatePowerupIndicator();

            // Create level specific elements
            createLevel(gameState.currentLevel);

            // Create clouds
            gameState.clouds = [];
            for (let i = 0; i < 5; i++) {
                gameState.clouds.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * 100 + 20,
                    width: 80 + Math.random() * 60,
                    height: 40 + Math.random() * 30,
                    speed: 0.5 + Math.random() * 0.5
                });
            }

            // Update UI displays
            updateGameUI();
        }

        function updateGameUI() {
            scoreDisplay.textContent = `Score: ${gameState.score}`;
            livesDisplay.textContent = `Lives: ${gameState.lives}`;
            timeDisplay.textContent = `Time: ${gameState.timeLeft}`;
            levelDisplay.textContent = `Level: ${gameState.currentLevel}`;
            coinsCount.textContent = gameState.honeyJars.length;
        }

        // Create level (from Bee and Honey, adapted)
        function createLevel(level) {
            gameState.platforms = [];
            gameState.coins = []; // Gold coins
            gameState.enemies = [];
            gameState.tunnels = [];
            gameState.tunnelExits = [];
            gameState.particles = [];
            gameState.flag = null;
            gameState.princess.saved = false; // Reset princess saved state

            // Adjust difficulty
            let enemySpeed = 2;
            let timeBonus = 0;

            if (gameState.settings.difficulty === 'easy') {
                enemySpeed = 1.5;
                timeBonus = 30;
            } else if (gameState.settings.difficulty === 'hard') {
                enemySpeed = 2.5;
                timeBonus = -30;
            }

            gameState.timeLeft = 120 + timeBonus;
            timeDisplay.textContent = `Time: ${gameState.timeLeft}`;

            // Always add the ground platform
            gameState.platforms.push({ x: 0, y: gameState.ground.y, width: canvas.width, height: gameState.ground.height, color: gameState.ground.color });


            // Level-specific elements
            if (level === 1) {
                // Level 1 - Forest Theme
                gameState.platforms.push({ x: 200, y: 480, width: 100, height: 20, color: '#8B4513' });
                gameState.platforms.push({ x: 350, y: 420, width: 100, height: 20, color: '#8B4513' });
                gameState.platforms.push({ x: 500, y: 450, width: 100, height: 20, color: '#8B4513' });

                gameState.coins.push({ x: 220, y: 440, radius: 8, collected: false });
                gameState.coins.push({ x: 370, y: 380, radius: 8, collected: false });
                gameState.coins.push({ x: 520, y: 410, radius: 8, collected: false });

                gameState.enemies.push({
                    x: 300,
                    y: gameState.ground.y - 40, /* Adjusted for enemy height */
                    width: 40,
                    height: 40,
                    speed: enemySpeed,
                    directionX: 1,
                    stomped: false
                });
                gameState.enemies.push({
                    x: 550,
                    y: gameState.ground.y - 40,
                    width: 40,
                    height: 40,
                    speed: enemySpeed,
                    directionX: -1,
                    stomped: false
                });

                gameState.tunnels.push({
                    x: 600,
                    y: gameState.ground.y - 50, /* Adjusted for tunnel height */
                    width: 40,
                    height: 50,
                });
                gameState.tunnelExits.push({ x: 650, y: 400 }); // Exit to a higher platform in same level

                gameState.princess = { // Reinitialize princess for the level
                    x: 700,
                    y: gameState.ground.y - 60,
                    width: 40,
                    height: 60,
                    saved: false
                };
                gameState.flag = null; // No flag in level 1, save princess directly

                gameState.backgroundElements = [];
                // Forest theme
                for (let i = 0; i < 10; i++) {
                    gameState.backgroundElements.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * 100 + 400,
                        width: 30 + Math.random() * 50,
                        height: 50 + Math.random() * 100,
                        color: '#2E8B57', // Sea green
                        speed: 0.2 + Math.random() * 0.3,
                        type: 'tree'
                    });
                }

            } else if (level === 2) {
                // Level 2 - Mountain Theme (more challenging)
                gameState.platforms.push({ x: 150, y: 380, width: 80, height: 20, color: '#8B4513' });
                gameState.platforms.push({ x: 300, y: 340, width: 80, height: 20, color: '#8B4513' });
                gameState.platforms.push({ x: 450, y: 380, width: 80, height: 20, color: '#8B4513' });
                gameState.platforms.push({ x: 600, y: 340, width: 80, height: 20, color: '#8B4513' });
                gameState.platforms.push({ x: 50, y: 450, width: 120, height: 20, color: '#8B4513' }); // New platform

                gameState.coins.push({ x: 170, y: 340, radius: 8, collected: false });
                gameState.coins.push({ x: 320, y: 300, radius: 8, collected: false });
                gameState.coins.push({ x: 470, y: 340, radius: 8, collected: false });
                gameState.coins.push({ x: 620, y: 300, radius: 8, collected: false });
                gameState.coins.push({ x: 80, y: 410, radius: 8, collected: false });

                gameState.enemies.push({
                    x: 200,
                    y: gameState.ground.y - 40,
                    width: 40,
                    height: 40,
                    speed: enemySpeed,
                    directionX: 1,
                    stomped: false
                });

                gameState.enemies.push({
                    x: 400,
                    y: gameState.ground.y - 40,
                    width: 40,
                    height: 40,
                    speed: enemySpeed,
                    directionX: -1,
                    stomped: false
                });
                gameState.enemies.push({
                    x: 350,
                    y: 300 - 40, // Enemy on higher platform
                    width: 40,
                    height: 40,
                    speed: enemySpeed * 0.9,
                    directionX: 1,
                    stomped: false
                });

                gameState.tunnels.push({
                    x: 700,
                    y: gameState.ground.y - 50,
                    width: 40,
                    height: 50,
                });
                gameState.tunnelExits.push({ x: 720, y: 380 }); // Exit to a higher platform

                gameState.princess = {
                    x: 750,
                    y: 320 - 60, // Princess is at a higher platform
                    width: 40,
                    height: 60,
                    saved: false
                };

                gameState.flag = {
                    x: 750,
                    y: 380 - 150, // Flag to mark level completion
                    width: 30,
                    height: 150,
                    color: '#FFD700',
                    poleColor: '#8B4513'
                };

                gameState.backgroundElements = [];
                // Mountain theme
                for (let i = 0; i < 8; i++) {
                    gameState.backgroundElements.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * 100 + 450,
                        width: 50 + Math.random() * 100,
                        height: 80 + Math.random() * 120,
                        color: '#708090', // Slate gray
                        speed: 0.3 + Math.random() * 0.4,
                        type: 'mountain'
                    });
                }
            } else if (level === 3) {
                // Level 3 - Cave Theme (more complex platforms, more enemies)
                gameState.timeLeft = 180 + timeBonus; // Even more time
                gameState.platforms.push({ x: 100, y: 480, width: 150, height: 20, color: '#8B4513' });
                gameState.platforms.push({ x: 300, y: 420, width: 100, height: 20, color: '#8B4513' });
                gameState.platforms.push({ x: 500, y: 360, width: 120, height: 20, color: '#8B4513' });
                gameState.platforms.push({ x: 650, y: 300, width: 80, height: 20, color: '#8B4513' });
                gameState.platforms.push({ x: 50, y: 300, width: 80, height: 20, color: '#8B4513' });
                gameState.platforms.push({ x: 200, y: 240, width: 100, height: 20, color: '#8B4513' });
                gameState.platforms.push({ x: 400, y: 180, width: 150, height: 20, color: '#8B4513' });

                gameState.coins.push({ x: 150, y: 440, radius: 8, collected: false });
                gameState.coins.push({ x: 330, y: 380, radius: 8, collected: false });
                gameState.coins.push({ x: 550, y: 320, radius: 8, collected: false });
                gameState.coins.push({ x: 700, y: 260, radius: 8, collected: false });
                gameState.coins.push({ x: 80, y: 260, radius: 8, collected: false });
                gameState.coins.push({ x: 250, y: 200, radius: 8, collected: false });
                gameState.coins.push({ x: 450, y: 140, radius: 8, collected: false });

                gameState.enemies.push({
                    x: 150,
                    y: 480 - 40,
                    width: 40,
                    height: 40,
                    speed: enemySpeed * 1.1,
                    directionX: 1,
                    stomped: false
                });
                gameState.enemies.push({
                    x: 350,
                    y: 420 - 40,
                    width: 40,
                    height: 40,
                    speed: enemySpeed * 1.2,
                    directionX: -1,
                    stomped: false
                });
                gameState.enemies.push({
                    x: 550,
                    y: 360 - 40,
                    width: 40,
                    height: 40,
                    speed: enemySpeed * 1.3,
                    directionX: 1,
                    stomped: false
                });
                gameState.enemies.push({
                    x: 250,
                    y: 240 - 40,
                    width: 40,
                    height: 40,
                    speed: enemySpeed * 1.0,
                    directionX: -1,
                    stomped: false
                });
                gameState.enemies.push({
                    x: 450,
                    y: 180 - 40,
                    width: 40,
                    height: 40,
                    speed: enemySpeed * 1.1,
                    directionX: 1,
                    stomped: false
                });

                gameState.tunnels.push({
                    x: 750,
                    y: gameState.ground.y - 50,
                    width: 40,
                    height: 50,
                });
                gameState.tunnelExits.push({ x: 50, y: 100 }); // Exit to top-left of map

                gameState.princess = {
                    x: 700,
                    y: 100 - 60, // Queen at top right
                    width: 40,
                    height: 60,
                    saved: false
                };
                gameState.flag = {
                    x: 700,
                    y: 160 - 150, // Flag near queen
                    width: 30,
                    height: 150,
                    color: '#FFD700',
                    poleColor: '#8B4513'
                };

                gameState.backgroundElements = [];
                // Cave theme - no background elements, just dark background
            }

            // Ensure enemy speed is not too low/high
            gameState.enemies.forEach(enemy => {
                enemy.speed = Math.max(1, Math.min(4, enemy.speed));
            });
        }

        // Game update logic (merged and adapted)
        function updateGame() {
            // Player movement
            if (gameState.keys.ArrowLeft || (gameState.settings.controls === 'wasd' && gameState.keys.a)) {
                gameState.player.x -= gameState.player.speed;
                gameState.player.direction = 'left';
            }
            if (gameState.keys.ArrowRight || (gameState.settings.controls === 'wasd' && gameState.keys.d)) {
                gameState.player.x += gameState.player.speed;
                gameState.player.direction = 'right';
            }

            // Apply gravity
            gameState.player.velocityY += 0.5;
            gameState.player.y += gameState.player.velocityY;

            // Collision with ground
            if (gameState.player.y + gameState.player.height > gameState.ground.y) {
                gameState.player.y = gameState.ground.y - gameState.player.height;
                gameState.player.velocityY = 0;
                gameState.player.isJumping = false;
            }

            // Jumping
            if ((gameState.keys.ArrowUp || (gameState.settings.controls === 'wasd' && gameState.keys.w) || gameState.keys[' ']) && !gameState.player.isJumping) {
                gameState.player.velocityY = -gameState.player.jumpForce;
                gameState.player.isJumping = true;
                playSound('jumpSound');
            }

            // Keep player within canvas bounds
            if (gameState.player.x < 0) gameState.player.x = 0;
            if (gameState.player.x + gameState.player.width > canvas.width) gameState.player.x = canvas.width - gameState.player.width;

            // Check platform collisions
            gameState.platforms.forEach(platform => {
                if (gameState.player.x + gameState.player.width > platform.x &&
                    gameState.player.x < platform.x + platform.width &&
                    gameState.player.y + gameState.player.height > platform.y &&
                    gameState.player.y + gameState.player.height < platform.y + platform.height + 10 &&
                    gameState.player.velocityY > 0) {
                    gameState.player.y = platform.y - gameState.player.height;
                    gameState.player.velocityY = 0;
                    gameState.player.isJumping = false;
                }
            });

            // Check tunnel collision
            gameState.tunnels.forEach((tunnel, index) => {
                if (gameState.player.x + gameState.player.width > tunnel.x &&
                    gameState.player.x < tunnel.x + tunnel.width &&
                    gameState.player.y + gameState.player.height > tunnel.y &&
                    (gameState.keys.ArrowDown || (gameState.settings.controls === 'wasd' && gameState.keys.s))) {
                    // Enter tunnel
                    startTransition(gameState.tunnelExits[index], gameState.currentLevel);
                    gameState.keys.ArrowDown = false; // Prevent continuous teleport
                    gameState.keys.s = false;
                    playSound('buttonClick'); // Use buttonClick sound for tunnel entry
                }
            });

            // Check flag collision (if flag exists)
            if (gameState.flag &&
                gameState.player.x + gameState.player.width > gameState.flag.x &&
                gameState.player.x < gameState.flag.x + gameState.flag.width &&
                gameState.player.y + gameState.player.height > gameState.flag.y) {
                completeLevel();
            }

            // Check princess collision
            if (!gameState.princess.saved &&
                gameState.player.x < gameState.princess.x + gameState.princess.width &&
                gameState.player.x + gameState.player.width > gameState.princess.x &&
                gameState.player.y < gameState.princess.y + gameState.princess.height &&
                gameState.player.y + gameState.player.height > gameState.princess.y) {
                gameState.princess.saved = true;
                gameState.score += 1000; // Bonus for saving princess
                gameState.honeyJars.push({ collected: true }); // Add a honey jar for saving
                // After rescuing the princess, a flag appears to signify level completion
                gameState.flag = {
                    x: gameState.princess.x,
                    y: gameState.princess.y + gameState.princess.height - 150, // Position flag near princess
                    width: 30,
                    height: 150,
                    color: '#FFD700',
                    poleColor: '#8B4513'
                };
                playSound('collectSound'); // Play sound for princess rescue
            }

            // Collision detection with coins (gold coins)
            gameState.coins.forEach((coin, index) => {
                if (!coin.collected &&
                    gameState.player.x < coin.x + coin.radius &&
                    gameState.player.x + gameState.player.width > coin.x - coin.radius &&
                    gameState.player.y < coin.y + coin.radius &&
                    gameState.player.y + gameState.player.height > coin.y - coin.radius) {
                    coin.collected = true;
                    gameState.score += 100; // Score for collecting coins
                    gameState.honeyJars.push({ collected: true }); // Add a honey jar for collecting a coin
                    playSound('collectSound');
                    updateGameUI();

                    // Create particle effect
                    for (let i = 0; i < 5; i++) { // Reduced particles for performance
                        gameState.particles.push({
                            x: coin.x,
                            y: coin.y,
                            radius: Math.random() * 4 + 2,
                            color: '#FFD700',
                            velocityX: Math.random() * 3 - 1.5,
                            velocityY: Math.random() * 3 - 1.5,
                            life: 20
                        });
                    }
                }
            });

            // Check enemy collisions
            gameState.enemies.forEach(enemy => {
                if (!enemy.stomped && !gameState.playerUpgrades.invincible &&
                    gameState.player.x + gameState.player.width > enemy.x &&
                    gameState.player.x < enemy.x + enemy.width &&
                    gameState.player.y + gameState.player.height > enemy.y &&
                    gameState.player.y < enemy.y + enemy.height) {

                    // Check if player is jumping on enemy (stomp)
                    if (gameState.player.velocityY > 0 && gameState.player.y + gameState.player.height < enemy.y + enemy.height / 2) {
                        // Bounce off enemy
                        gameState.player.velocityY = -gameState.player.jumpForce * 0.8;
                        enemy.stomped = true; // Mark as stomped so it doesn't hurt player again
                        gameState.score += 200;
                        gameState.honeyJars.push({ collected: true }); // Add a honey jar for stomping enemy
                        playSound('stompSound');
                        updateGameUI();
                    } else {
                        // Player gets hurt
                        gameState.lives--;
                        livesDisplay.textContent = `Lives: ${gameState.lives}`;
                        // Reset player position and grant temporary invincibility
                        gameState.player.x = 50;
                        gameState.player.y = gameState.ground.y - gameState.player.height;
                        gameState.playerUpgrades.invincible = true;
                        gameState.playerUpgrades.invincibleEndTime = Date.now() + 2000; // 2 seconds invincibility
                        playSound('hurtSound');

                        if (gameState.lives <= 0) {
                            gameOver();
                        }
                    }
                }
            });

            // Update enemies - Improved AI
            gameState.enemies.forEach(enemy => {
                if (!enemy.stomped) {
                    let nextEnemyX = enemy.x + enemy.speed * enemy.directionX;
                    let willFall = true;
                    let hitWall = false;

                    // Check if enemy is on a platform and will fall off
                    for (const platform of gameState.platforms) {
                        // Check if enemy's current position is on this platform
                        if (enemy.y + enemy.height >= platform.y - 5 && enemy.y + enemy.height <= platform.y + 5) {
                            // Check if the next step would take the enemy off the platform edge
                            if (nextEnemyX >= platform.x && nextEnemyX + enemy.width <= platform.x + platform.width) {
                                willFall = false; // Enemy will stay on this platform
                                break;
                            }
                        }
                    }

                    // Check screen boundaries
                    if (nextEnemyX <= 0 || nextEnemyX + enemy.width >= canvas.width) {
                        hitWall = true;
                    }

                    // If enemy will fall or hit a wall, reverse direction
                    if (willFall || hitWall) {
                        enemy.directionX *= -1;
                    }

                    // Move enemy
                    enemy.x += enemy.speed * enemy.directionX;
                }
            });

            // Update player speed based on upgrades
            if (gameState.playerUpgrades.speed && Date.now() < gameState.playerUpgrades.speedEndTime) {
                gameState.player.speed = gameState.player.baseSpeed * 1.5;
            } else {
                gameState.playerUpgrades.speed = false;
                gameState.player.speed = gameState.player.baseSpeed;
            }

            // Update invincibility
            if (gameState.playerUpgrades.invincible && Date.now() >= gameState.playerUpgrades.invincibilityEndTime) {
                gameState.playerUpgrades.invincible = false;
            }

            // Update particles
            for (let i = gameState.particles.length - 1; i >= 0; i--) {
                const p = gameState.particles[i];
                p.x += p.velocityX;
                p.y += p.velocityY;
                p.life--;
                if (p.life <= 0) {
                    gameState.particles.splice(i, 1);
                }
            }

            // Update clouds
            gameState.clouds.forEach(cloud => {
                cloud.x -= cloud.speed;
                if (cloud.x + cloud.width < 0) {
                    cloud.x = canvas.width;
                    cloud.y = Math.random() * 100 + 20;
                }
            });

            updatePowerupIndicator();
        }

        // Game drawing logic (merged and adapted)
        function drawGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw sky background with theme
            let gradient;
            if (gameState.currentLevel === 1) {
                // Forest theme - bright blue sky
                gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#87CEEB');
                gradient.addColorStop(1, '#E0F7FA');
            } else if (gameState.currentLevel === 2) {
                // Mountain theme - sunset colors
                gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#FF7F50'); // Coral
                gradient.addColorStop(0.5, '#FFA07A'); // Light salmon
                gradient.addColorStop(1, '#E0F7FA'); // Light cyan
            } else if (gameState.currentLevel === 3) {
                // Cave theme - dark, mysterious
                gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, '#323246'); // Dark blue-gray
                gradient.addColorStop(1, '#1A1A2E'); // Even darker blue-gray
            }
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw background elements (mountains, trees, etc.)
            gameState.backgroundElements.forEach(element => {
                element.x -= element.speed;
                if (element.x + element.width < 0) {
                    element.x = canvas.width;
                }

                ctx.fillStyle = element.color;

                if (element.type === 'tree') {
                    // Draw tree trunk
                    ctx.fillRect(element.x + element.width / 2 - 5, element.y, 10, element.height);
                    // Draw tree leaves (triangle)
                    ctx.beginPath();
                    ctx.moveTo(element.x, element.y);
                    ctx.lineTo(element.x + element.width / 2, element.y - element.height / 2);
                    ctx.lineTo(element.x + element.width, element.y);
                    ctx.closePath();
                    ctx.fill();
                } else if (element.type === 'mountain') {
                    // Draw mountains
                    ctx.beginPath();
                    ctx.moveTo(element.x, element.y);
                    ctx.lineTo(element.x + element.width / 2, element.y - element.height);
                    ctx.lineTo(element.x + element.width, element.y);
                    ctx.closePath();
                    ctx.fill();
                }
            });

            // Draw clouds
            gameState.clouds.forEach(cloud => {
                ctx.drawImage(cloudImage, cloud.x, cloud.y, cloud.width, cloud.height);
            });

            // Draw ground
            ctx.fillStyle = gameState.ground.color;
            ctx.fillRect(0, gameState.ground.y, canvas.width, gameState.ground.height);
            // Draw grass on top
            ctx.fillStyle = '#2E8B57'; // Sea green
            ctx.fillRect(0, gameState.ground.y, canvas.width, 10);
            // Draw some grass details
            ctx.fillStyle = '#3CB371'; // Medium sea green
            for (let i = 0; i < canvas.width; i += 20) {
                ctx.beginPath();
                ctx.moveTo(i, gameState.ground.y);
                ctx.lineTo(i + 10, gameState.ground.y - 15);
                ctx.lineTo(i + 20, gameState.ground.y);
                ctx.closePath();
                ctx.fill();
            }

            // Draw platforms
            gameState.platforms.forEach(platform => {
                ctx.fillStyle = platform.color;
                ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
                // Draw wooden details
                ctx.fillStyle = '#A0522D'; // Sienna
                for (let i = 0; i < platform.width; i += 20) {
                    ctx.fillRect(platform.x + i, platform.y, 10, platform.height);
                }
            });

            // Draw tunnels
            gameState.tunnels.forEach(tunnel => {
                ctx.fillStyle = '#654321'; // Dark brown
                ctx.fillRect(tunnel.x, tunnel.y, tunnel.width, tunnel.height);
                // Draw tunnel entrance (arch)
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(tunnel.x + tunnel.width / 2, tunnel.y + 10, tunnel.width / 2 - 5, 0, Math.PI, true); // Arc for opening
                ctx.fill();
                // Draw arrow if player is near and can enter
                if (gameState.player.x + gameState.player.width > tunnel.x &&
                    gameState.player.x < tunnel.x + tunnel.width &&
                    gameState.player.y + gameState.player.height > tunnel.y) {
                    ctx.fillStyle = '#FFD700'; // Gold
                    ctx.beginPath();
                    ctx.moveTo(tunnel.x + tunnel.width / 2, tunnel.y + 25);
                    ctx.lineTo(tunnel.x + tunnel.width / 2 - 10, tunnel.y + 35);
                    ctx.lineTo(tunnel.x + tunnel.width / 2 + 10, tunnel.y + 35);
                    ctx.closePath();
                    ctx.fill();
                }
            });

            // Draw coins (gold coins)
            ctx.fillStyle = '#FFD700'; // Gold
            gameState.coins.forEach(coin => {
                if (!coin.collected) {
                    ctx.beginPath();
                    ctx.arc(coin.x, coin.y, coin.radius, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.strokeStyle = '#DAA520'; // Darker gold
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            });

            // Draw enemies
            gameState.enemies.forEach(enemy => {
                if (!enemy.stomped) {
                    ctx.drawImage(enemyImage, enemy.x, enemy.y, enemy.width, enemy.height);
                }
            });

            // Draw princess
            if (!gameState.princess.saved) {
                ctx.drawImage(honeyQueenImage, gameState.princess.x, gameState.princess.y, gameState.princess.width, gameState.princess.height);
                // Draw exclamation mark
                ctx.fillStyle = '#FF0000';
                ctx.fillRect(gameState.princess.x + gameState.princess.width / 2 - 3, gameState.princess.y - 20, 6, 15);
                ctx.beginPath();
                ctx.arc(gameState.princess.x + gameState.princess.width / 2, gameState.princess.y - 30, 6, 0, Math.PI * 2);
                ctx.fill();
            }

            // Draw flag
            if (gameState.flag) {
                // Draw flag pole
                ctx.fillStyle = gameState.flag.poleColor;
                ctx.fillRect(gameState.flag.x, gameState.flag.y, 5, gameState.flag.height);
                // Draw flag
                ctx.fillStyle = gameState.flag.color;
                ctx.beginPath();
                ctx.moveTo(gameState.flag.x + 5, gameState.flag.y + 10);
                ctx.lineTo(gameState.flag.x + 25, gameState.flag.y + 20);
                ctx.lineTo(gameState.flag.x + 5, gameState.flag.y + 30);
                ctx.closePath();
                ctx.fill();
            }

            // Draw particles
            gameState.particles.forEach(particle => {
                ctx.fillStyle = `rgba(${parseInt(particle.color.substring(1, 3), 16)}, ${parseInt(particle.color.substring(3, 5), 16)}, ${parseInt(particle.color.substring(5, 7), 16)}, ${particle.life / 20})`; // Fade out
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.radius, 0, Math.PI * 2);
                ctx.fill();
            });

            // Draw player (Prince) with customization
            ctx.save();
            ctx.translate(gameState.player.x + gameState.player.width / 2, gameState.player.y + gameState.player.height / 2);

            if (gameState.player.direction === 'left') {
                ctx.scale(-1, 1);
            }

            // Apply invincibility effect (flicker)
            if (gameState.playerUpgrades.invincible && Math.floor(Date.now() / 100) % 2 === 0) {
                ctx.globalAlpha = 0.7;
            }
            ctx.drawImage(playerImageInstance, -gameState.player.width / 2, -gameState.player.height / 2, gameState.player.width, gameState.player.height);
            ctx.restore();

            // Animation for player frame (for walking animation, not used with custom drawing)
            // If we were using a sprite sheet, this would update the frame.
            // For now, it just increments, but doesn't affect the custom drawing.
            gameState.player.frameCount++;
            if (gameState.player.frameCount >= 10) {
                gameState.player.frame = (gameState.player.frame + 1) % 4;
                gameState.player.frameCount = 0;
            }
        }

        // Game loop (merged)
        function gameLoop() {
            if (!gameState.gameRunning) return; // Stop if game is not running
            updateGame();
            drawGame();
            gameState.animationFrameId = requestAnimationFrame(gameLoop);
        }

        function startGameLoop() {
            if (!gameState.gameRunning) {
                gameState.gameRunning = true;
                gameLoop();
                startGameTimer(); // Start the game timer
            }
        }

        // Game timer (from Bee and Honey)
        function startGameTimer() {
            clearInterval(gameState.gameTimeInterval);
            gameState.gameTimeInterval = setInterval(() => {
                gameState.timeLeft--;
                timeDisplay.textContent = `Time: ${gameState.timeLeft}`;

                if (gameState.timeLeft <= 0) {
                    gameOver();
                }
            }, 1000);
        }

        // Start game (merged and adapted)
        function startGame(level = 1) {
            gameState.gameRunning = true;
            initGame(level); // Initialize game state for a new game or specific level
            showScreen('gameCanvas'); // Show the game canvas
        }

        // Next level (from Bee and Honey)
        function nextLevel() {
            if (gameState.currentLevel < gameState.maxLevel) {
                gameState.currentLevel++;
                startGame(gameState.currentLevel); // Start the next level
            } else {
                // All levels completed, show game over/won screen
                gameOver(true); // Pass true to indicate game won
            }
        }

        // Complete level (from Bee and Honey, adapted)
        function completeLevel() {
            gameState.gameRunning = false;
            clearInterval(gameState.gameTimeInterval);
            cancelAnimationFrame(gameState.animationFrameId);

            // Bonus points for time left
            const timeBonus = gameState.timeLeft * 10;
            gameState.score += timeBonus;

            // Bonus honey jars for level completion
            const honeyJarsBonus = gameState.currentLevel * 5;
            for (let i = 0; i < honeyJarsBonus; i++) {
                gameState.honeyJars.push({ collected: true });
            }
            coinsCount.textContent = gameState.honeyJars.length;

            levelScore.textContent = `Score: ${gameState.score}`;
            levelCoins.textContent = `+${honeyJarsBonus} Honey Jars`;

            if (gameState.currentLevel < gameState.maxLevel) {
                playSound('winSound'); // Use winSound for level complete
                showScreen('level-complete-screen');
            } else {
                // Game completed (all levels done)
                gameOver(true); // Indicate game won
            }
            saveGameState(); // Save state after level completion
        }

        // Game over (from Bee and Honey, adapted)
        function gameOver(gameWon = false) {
            gameState.gameRunning = false;
            clearInterval(gameState.gameTimeInterval);
            cancelAnimationFrame(gameState.animationFrameId);

            finalScore.textContent = `Final Score: ${gameState.score}`;

            // Calculate honey jars earned (10% of score rounded)
            const earnedHoneyJars = Math.round(gameState.score * 0.1);
            for (let i = 0; i < earnedHoneyJars; i++) {
                gameState.honeyJars.push({ collected: true });
            }
            coinsCount.textContent = gameState.honeyJars.length;
            coinsEarned.textContent = `+${earnedHoneyJars} Honey Jars`;

            updateLeaderboard(gameState.score);

            if (gameWon) {
                // Display a "You Won!" message or similar on the game over screen
                document.querySelector('#game-over-screen h1').textContent = "YOU WON!";
                document.querySelector('#game-over-screen h1').style.color = '#00FF00'; // Green for win
            } else {
                document.querySelector('#game-over-screen h1').textContent = "GAME OVER";
                document.querySelector('#game-over-screen h1').style.color = '#FF0000'; // Red for game over
            }

            showScreen('game-over-screen');
            saveGameState(); // Save state after game over
        }

        // Show menu (from Bee and Honey, adapted to my showScreen)
        function showMenu() {
            showScreen('homepage-screen');
        }

        // Show leaderboard (from Bee and Honey, adapted to my showScreen)
        function showLeaderboard() {
            showScreen('leaderboard-screen');
        }

        // Show shop (from Bee and Honey, adapted to my showScreen)
        function showShop() {
            showScreen('shop-screen');
        }

        // Show settings (from Bee and Honey, adapted to my showScreen)
        function showSettings() {
            // Set initial values in settings UI
            difficultySelect.value = gameState.settings.difficulty;
            volumeSlider.value = gameState.settings.musicVolume;
            sfxVolumeSlider.value = gameState.settings.sfxVolume;
            soundSelect.value = gameState.settings.soundEnabled ? 'on' : 'off';
            controlsSelect.value = gameState.settings.controls;
            darkModeToggle.checked = gameState.settings.darkMode;

            showScreen('settings-screen');
        }

        // Update powerup indicator (from Bee and Honey)
        function updatePowerupIndicator() {
            powerupIndicator.innerHTML = '';

            if (gameState.playerUpgrades.speed && Date.now() < gameState.playerUpgrades.speedEndTime) {
                const speedIcon = document.createElement('div');
                speedIcon.className = 'powerup-icon';
                speedIcon.innerHTML = '';
                speedIcon.title = 'Speed Boost Active';
                powerupIndicator.appendChild(speedIcon);

                const timer = document.createElement('div');
                timer.style.fontSize = '8px';
                timer.style.marginTop = '-5px';
                speedIcon.appendChild(timer);

                const updateTimer = () => {
                    const timeLeft = Math.ceil((gameState.playerUpgrades.speedEndTime - Date.now()) / 1000);
                    timer.textContent = timeLeft;
                    if (timeLeft > 0) {
                        requestAnimationFrame(updateTimer);
                    }
                };
                updateTimer();
            }

            if (gameState.playerUpgrades.invincible && Date.now() < gameState.playerUpgrades.invincibleEndTime) {
                const invincibleIcon = document.createElement('div');
                invincibleIcon.className = 'powerup-icon';
                invincibleIcon.innerHTML = '';
                invincibleIcon.title = 'Invincibility Active';
                powerupIndicator.appendChild(invincibleIcon);

                const timer = document.createElement('div');
                timer.style.fontSize = '8px';
                timer.style.marginTop = '-5px';
                invincibleIcon.appendChild(timer);

                const updateTimer = () => {
                    const timeLeft = Math.ceil((gameState.playerUpgrades.invincibleEndTime - Date.now()) / 1000);
                    timer.textContent = timeLeft;
                    if (timeLeft > 0) {
                        requestAnimationFrame(updateTimer);
                    }
                };
                updateTimer();
            }
        }

        // Update difficulty (from Bee and Honey)
        function updateDifficulty() {
            gameState.settings.difficulty = difficultySelect.value;
            difficultyIndicator.textContent = `Difficulty: ${gameState.settings.difficulty.charAt(0).toUpperCase() + gameState.settings.difficulty.slice(1)}`;
            saveGameState(); // Save settings
        }

        // Update sound settings (from Bee and Honey, adapted)
        function updateSound() {
            gameState.settings.soundEnabled = soundSelect.value === 'on';
            if (gameState.settings.soundEnabled && gameState.currentScreen === 'game' && gameState.audio.backgroundMusic && gameState.audio.backgroundMusic.paused) {
                gameState.audio.backgroundMusic.play().catch(e => console.error("Error playing background music:", e));
            } else if (!gameState.settings.soundEnabled && gameState.audio.backgroundMusic) {
                gameState.audio.backgroundMusic.pause();
            }
            saveGameState(); // Save settings
        }

        // Update controls (from Bee and Honey)
        function updateControls() {
            gameState.settings.controls = controlsSelect.value;
            saveGameState(); // Save settings
        }

        // Level Selection Screen
        function renderLevelSelection() {
            levelSelectionButtonsDiv.innerHTML = ''; // Clear existing buttons

            for (let i = 1; i <= gameState.maxLevel; i++) {
                const levelButton = document.createElement('div');
                levelButton.className = 'p-4 bg-gray-100 dark:bg-gray-600 rounded-lg shadow flex items-center justify-between';
                levelButton.innerHTML = `<span class="font-semibold text-lg">Level ${i}</span>`;

                const playBtn = document.createElement('button');
                playBtn.className = 'btn btn-primary text-sm py-2 px-4';
                playBtn.textContent = 'Play';
                playBtn.dataset.level = i;
                playBtn.onclick = (event) => {
                    playSound('buttonClick');
                    const levelToLoad = parseInt(event.target.dataset.level);
                    startGame(levelToLoad);
                };
                levelButton.appendChild(playBtn);
                levelSelectionButtonsDiv.appendChild(levelButton);
                playLevelButtons[`level-${i}`] = playBtn; // Store reference
            }
            // Add a placeholder for locked levels if needed, or dynamically unlock
        }

        // Transition Logic
        function startTransition(targetPos, targetLevel) {
            gameState.transitionState = 1; // Start fade out
            gameState.transitionAlpha = 0;
            gameState.transitionTargetPos = targetPos;
            gameState.transitionTargetLevel = targetLevel;
            gameState.gameRunning = false; // Pause game logic during transition
            if (gameState.audio.backgroundMusic && gameState.audio.backgroundMusic.isPlaying()) {
                gameState.audio.backgroundMusic.pause();
                gameState.audio.backgroundMusic.currentTime = 0; // Rewind for next play
            }
            requestAnimationFrame(updateTransition); // Start transition animation
        }

        function updateTransition() {
            // Always draw the game state *before* drawing the overlay
            drawGame();

            if (gameState.transitionState === 1) { // Fade out
                gameState.transitionAlpha += 10; // Increase alpha
                if (gameState.transitionAlpha >= 255) {
                    gameState.transitionAlpha = 255;
                    // Fully faded, now teleport and start fading in
                    gameState.player.x = gameState.transitionTargetPos.x;
                    gameState.player.y = gameState.transitionTargetPos.y;
                    gameState.currentLevel = gameState.transitionTargetLevel;
                    createLevel(gameState.currentLevel); // Re-initialize level for new position
                    gameState.transitionState = 2; // Start fade in
                }
            } else if (gameState.transitionState === 2) { // Fade in
                gameState.transitionAlpha -= 10; // Decrease alpha
                if (gameState.transitionAlpha <= 0) {
                    gameState.transitionAlpha = 0;
                    gameState.transitionState = 0; // Transition complete
                    gameState.gameRunning = true; // Resume game
                    // Reset timer if needed, or just continue
                    // We restart the game loop via startGameLoop() on screen change
                    if (gameState.audio.backgroundMusic) {
                        gameState.audio.backgroundMusic.loop = true;
                        gameState.audio.backgroundMusic.play().catch(e => console.error("Error playing background music:", e));
                    }
                }
            }

            if (gameState.transitionState !== 0) {
                drawTransitionOverlay();
                requestAnimationFrame(updateTransition);
            }
        }

        function drawTransitionOverlay() {
            ctx.fillStyle = `rgba(0, 0, 0, ${gameState.transitionAlpha / 255})`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }


        // Leaderboard functions (from Bee and Honey)
        function getLeaderboard() {
            const leaderboard = JSON.parse(localStorage.getItem('honeyQuestLeaderboard')) || [];
            return leaderboard.sort((a, b) => b.score - a.score).slice(0, 10);
        }

        function updateLeaderboard(score) {
            const name = `Player${Math.floor(Math.random() * 1000)}`;
            const date = new Date().toLocaleDateString();

            const leaderboard = getLeaderboard();
            leaderboard.push({ name, score, date });

            localStorage.setItem('honeyQuestLeaderboard', JSON.stringify(leaderboard));
        }

        function renderLeaderboard() {
            const leaderboard = getLeaderboard();
            leaderboardBody.innerHTML = '';

            if (leaderboard.length === 0) {
                leaderboardBody.innerHTML = '<tr><td colspan="4">No scores yet!</td></tr>';
                return;
            }

            leaderboard.forEach((entry, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${entry.name}</td>
                    <td>${entry.score}</td>
                    <td>${entry.date}</td>
                `;
                leaderboardBody.appendChild(row);
            });
        }

        // --- Persistent State (using localStorage) ---
        function saveGameState() {
            localStorage.setItem('princePrincessGameState', JSON.stringify({
                honeyJars: gameState.honeyJars.length, // Only save count for simplicity
                inventory: gameState.inventory,
                settings: gameState.settings,
                playerCustomization: {
                    skinColor: gameState.player.skinColor,
                    outfitColor: gameState.player.outfitColor,
                    hasCrown: gameState.player.hasCrown,
                    hasWings: gameState.player.hasWings,
                }
            }));
        }

        function loadGameState() {
            const savedState = JSON.parse(localStorage.getItem('princePrincessGameState'));
            if (savedState) {
                // Recreate honeyJars array based on saved count
                gameState.honeyJars = Array(savedState.honeyJars).fill({ collected: true });
                gameState.inventory = savedState.inventory;
                gameState.settings = savedState.settings;
                // Load player customization
                if (savedState.playerCustomization) {
                    gameState.player.skinColor = savedState.playerCustomization.skinColor;
                    gameState.player.outfitColor = savedState.playerCustomization.outfitColor;
                    gameState.player.hasCrown = savedState.playerCustomization.hasCrown;
                    gameState.player.hasWings = savedState.playerCustomization.hasWings;
                }

                // Apply loaded settings to UI
                document.body.classList.toggle('dark-mode', gameState.settings.darkMode);
                darkModeToggle.checked = gameState.settings.darkMode;
                volumeSlider.value = gameState.settings.musicVolume;
                sfxVolumeSlider.value = gameState.settings.sfxVolume;
                difficultySelect.value = gameState.settings.difficulty;
                soundSelect.value = gameState.settings.soundEnabled ? 'on' : 'off';
                controlsSelect.value = gameState.settings.controls;

                updateVolume(); // Apply loaded volume settings
                updateDifficulty(); // Apply loaded difficulty setting
            }
        }

        // --- Image Assets (from Bee and Honey) ---
        // Player image is now drawn dynamically based on customization
        // const playerImage = new Image();
        // playerImage.src = '...';

        const enemyImage = new Image();
        enemyImage.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMjggMTI4IiBmaWxsPSJub25lIj48c3R5bGU+dHNwYW4geyB3aGl0ZS1zcGFjZTpwcmUgfSBzaGFwZSB7IGZpbGw6IHZhcigtLWNvbG9yKTsgfTwvc3R5bGU+PHBhdGggZD0iTTY0IDE2Yy0yNi41IDAtNDggMjEuNS00OCA0OHMyMS41IDQ4IDQ4IDQ4IDQ4LTIxLjUgNDgtNDhTOTAuNSAxNiA2NCAxNnoiIGNsYXNzPSJzaGFwZSIgc3R5bGU9Ii0tY29sb3I6ICNGRjQyNDIiLz48cGF0aCBkPSJNNjQgMzJjMTcuNyAwIDMyIDE0LjMgMzIgMzJzLTE0LjMgMzItMzIgMzItMzItMTQuMy0zMi0zMiAxNC4zLTMyIDMyLTMyeiIgY2xhc3M9InNoYXBlIiBzdHlsZT0iLS1jb2xvcjogI0ZGN0I4QiIvPjxwYXRoIGQ9Ik00OCA2NGMwLTguOCA3LjItMTYgMTYtMTZzMTYgNy4yIDE2IDE2LTcuMiAxNi0xNiAxNi0xNi03LjItMTYtMTZ6IiBjbGFzcz0ic2hhc2UiIHN0eWxlPSItLWNvbG9yOiAjRkY0MjQyIiIvPjxwYXRoIGQ9Ik00OCA2NGMwLTQuNCAzLjYtOCA4LThzOCAzLjYgOCAzLjYgOC0zLjYtOC04LTgtMy42LTgtOHoiIGNsYXNzPSJzaGFwZSIgc3R5bGU9Ii0tY29sb3I6ICNGRjdCOEIiLz48cGF0aCBkPSJNOTYgNjRjMC00LjQgMy42LTggOC04czggMy42IDggOC0zLjYgOC04IDgtOC0zLjYtOC04eiIgY2xhc3M9InNoYXBlIiBzdHlsZT0iLS1jb2xvcjogI0ZGN0I4QiIvPjxwYXRoIGQ9Ik03MiA0OGMwLTQuNCAzLjYtOCA4LThzOCAzLjYgOCA4LTMuNiA4LTggOC04LTMuNi04LTh6IiBjbGFzcz0ic2hhc2UiIHN0eWxlPSItLWNvbG9yOiAjRkY0MjQyIiIvPjwvc3ZnPg==';

        const honeyQueenImage = new Image();
        honeyQueenImage.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMjggMTI4IiBmaWxsPSJub25lIj48c3R5bGU+dHNwYW4geyB3aGl0ZS1zcGFjZTpwcmUgfSBzaGFwZSB7IGZpbGw6IHZhcigtLWNvbG9yKTsgfTwvc3R5bGU+PHBhdGggZD0iTTY0IDE2Yy0yNi41IDAtNDggMjEuNS00OCA0OHMyMS41IDQ4IDQ4IDQ4IDQ4LTIxLjUgNDgtNDhTOTAuNSAxNiA2NCAxNnoiIGNsYXNzPSJzaGFwZSIgc3R5bGU9Ii0tY29sb3I6ICNGRkQ3MDAiLz48cGF0aCBkPSJNNjQgMzJjMTcuNyAwIDMyIDE0LjMgMzIgMzJzLTE0LjMgMzItMzIgMzItMzItMTQuMy0zMi0zMiAxNC4zLTMyIDMyLTMyeiIgY2xhc3M9InNoYXBlIiBzdHlsZT0iLS1jb2xvcjogI0ZGRUIzQiIvPjxwYXRoIGQ9Ik00OCA2NGMwLTguOCA3LjItMTYgMTYtMTZzMTYgNy4yIDE2IDE2LTcuMiAxNi0xNiAxNi0xNi03LjItMTYtMTZ6IiBjbGFzcz0ic2hhc2UiIHN0eWxlPSItLWNvbG9yOiAjRkZENzAwIiIvPjxwYXRoIGQ9Ik00OCA2NGMwLTQuNCAzLjYtOCA4LThzOCAzLjYgOCAzLjYgOC0zLjYtOC04LTgtMy42LTgtOHoiIGNsYXNzPSJzaGFwZSIgc3R5bGU9Ii0tY29sb3I6ICNGRkVCQ0IiLz48cGF0aCBkPSJNOTYgNjRjMC00LjQgMy42LTggOC04czggMy42IDggOC0zLjYgOC04IDgtOC0zLjYtOC04eiIgY2xhc3M9InNoYXBlIiBzdHlsZT0iLS1jb2xvcjogI0ZGRUJDQiIvPjxwYXRoIGQ9Ik03MiA0OGMwLTQuNCAzLjYtOCA4LThzOCAzLjYgOCA4LTMuNiA4LTggOC04LTMuNi04LTh6IiBjbGFzcz0ic2hhc2UiIHN0eWxlPSItLWNvbG9yOiAjRkZENzAwIiIvPjxwYXRoIGQ9Ik02NCAxMTJjOC44IDAgMTYtNy4yIDE2LTE2SDY4YzAtOC44IDcuMi0xNiAxNi0xNnptMC00LjRjLTQuNCAwLTgtMy42LTgtOHM0LjQtOC04LThzLTggMy42LTggOHM0LjQgOC04IDh6IiBjbGFzcz0ic2hhcGUiIHN0eWxlPSItLWNvbG9yOiAjRkZGNzAwIiIvPjwvc3ZnPg==';

        const cloudImage = new Image();
        cloudImage.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMjggMTI4Ij48cGF0aCBkPSJNMTEyIDY0YzAgMjYuNS0yMS41IDQ4LTQ4IDQ4SDE2QzcuMiAxMTIgMCAxMDQuOCAwIDk2czcuMi0xNiAxNi0xNmgxNmM4LjggMCAxNi03LjIgMTYtMTZzLTcuMi0xNi0xNi0xNkgxNmMtOC44IDAtMTYtNy4yLTE2LTE2czcuMi0xNiAxNi0xNmg0OGMyNi41IDAgNDggMjEuNSA0OCA0OHoiIGZpbGw9IiNGRkZGRkYiLz48L3N2Z2Q==';


        // --- Event Listeners (merged and adapted) ---
        // Moved all DOM element selections and event listener attachments inside window.onload
        window.onload = function() {
            // Assign DOM elements now that the DOM is fully loaded
            uiOverlay = document.getElementById('ui-overlay');
            homepageScreen = document.getElementById('homepage-screen');
            shopScreen = document.getElementById('shop-screen');
            inventoryScreen = document.getElementById('inventory-screen');
            settingsScreen = document.getElementById('settings-screen');
            levelsScreen = document.getElementById('levels-screen');
            dailyChallengesScreen = document.getElementById('daily-challenges-screen');
            gameOverScreen = document.getElementById('game-over-screen');
            levelCompleteScreen = document.getElementById('level-complete-screen');
            leaderboardScreen = document.getElementById('leaderboard-screen');
            customizeScreen = document.getElementById('customize-screen');

            startGameBtn = document.getElementById('start-game-btn');
            shopBtn = document.getElementById('shop-btn');
            inventoryBtn = document.getElementById('inventory-btn');
            levelsBtn = document.getElementById('levels-btn');
            dailyChallengesBtn = document.getElementById('daily-challenges-btn');
            settingsBtn = document.getElementById('settings-btn');
            leaderboardButton = document.getElementById('leaderboard-button');
            customizeBtn = document.getElementById('customize-btn');

            shopBackBtn = document.getElementById('shop-back-btn');
            inventoryBackBtn = document.getElementById('inventory-back-btn');
            levelsBackBtn = document.getElementById('levels-back-btn');
            dailyChallengesBackBtn = document.getElementById('daily-challenges-back-btn');
            settingsBackBtn = document.getElementById('settings-back-btn');
            customizeBackBtn = document.getElementById('customize-back-btn');

            restartButton = document.getElementById('restart-button');
            menuButton = document.getElementById('menu-button');
            nextLevelButton = document.getElementById('next-level-button');
            menuLevelButton = document.getElementById('menu-level-button');
            backButton = document.getElementById('back-button');

            levelSelectionButtonsDiv = document.getElementById('level-selection-buttons');

            menuButtonNav = document.getElementById('menu-button-nav');
            shopButtonNav = document.getElementById('shop-button-nav');
            settingsButtonNav = document.getElementById('settings-button-nav');

            scoreDisplay = document.getElementById('score-display');
            livesDisplay = document.getElementById('lives-display');
            timeDisplay = document.getElementById('time-display');
            levelDisplay = document.getElementById('level-display');
            finalScore = document.getElementById('final-score');
            levelScore = document.getElementById('level-score');
            coinsEarned = document.getElementById('coins-earned');
            levelCoins = document.getElementById('level-coins');
            leaderboardBody = document.getElementById('leaderboard-body');
            coinsCount = document.getElementById('coins-count');
            shopCoinsCount = document.getElementById('shop-coins-count');
            customizeCoinsCount = document.getElementById('customize-coins-count');
            difficultyIndicator = document.getElementById('difficulty-indicator');
            powerupIndicator = document.getElementById('powerup-indicator');

            shopItemsDiv = document.getElementById('shop-items');
            inventoryItemsDiv = document.getElementById('inventory-items');

            volumeSlider = document.getElementById('volume-slider');
            sfxVolumeSlider = document.getElementById('sfx-volume-slider');
            darkModeToggle = document.getElementById('dark-mode-toggle');
            difficultySelect = document.getElementById('difficulty');
            soundSelect = document.getElementById('sound');
            controlsSelect = document.getElementById('controls');

            playerPreviewCanvas = document.getElementById('player-preview-canvas');
            playerPreviewCtx = playerPreviewCanvas.getContext('2d');
            skinColorOptionsDiv = document.getElementById('skin-color-options');
            outfitColorOptionsDiv = document.getElementById('outfit-color-options');
            buyCrownBtn = document.getElementById('buy-crown-btn');
            buyWingsBtn = document.getElementById('buy-wings-btn');
            crownStatusSpan = document.getElementById('crown-status');
            wingsStatusSpan = document.getElementById('wings-status');

            messageBox = document.getElementById('message-box');
            messageBoxText = document.getElementById('message-box-text');
            messageBoxOkBtn = document.getElementById('message-box-ok');
            messageBoxCancelBtn = document.getElementById('message-box-cancel');

            // Now attach event listeners
            startGameBtn.addEventListener('click', () => { playSound('buttonClick'); startGame(1); });
            shopBtn.addEventListener('click', () => { playSound('buttonClick'); showScreen('shop-screen'); });
            inventoryBtn.addEventListener('click', () => { playSound('buttonClick'); showScreen('inventory-screen'); });
            levelsBtn.addEventListener('click', () => { playSound('buttonClick'); showScreen('levels-screen'); });
            dailyChallengesBtn.addEventListener('click', () => { playSound('buttonClick'); showScreen('daily-challenges-screen'); });
            settingsBtn.addEventListener('click', () => { playSound('buttonClick'); showScreen('settings-screen'); });
            leaderboardButton.addEventListener('click', () => { playSound('buttonClick'); showScreen('leaderboard-screen'); });
            customizeBtn.addEventListener('click', () => { playSound('buttonClick'); showScreen('customize-screen'); });

            shopBackBtn.addEventListener('click', () => { playSound('buttonClick'); showScreen('homepage-screen'); });
            inventoryBackBtn.addEventListener('click', () => { playSound('buttonClick'); showScreen('homepage-screen'); });
            levelsBackBtn.addEventListener('click', () => { playSound('buttonClick'); showScreen('homepage-screen'); });
            dailyChallengesBackBtn.addEventListener('click', () => { playSound('buttonClick'); showScreen('homepage-screen'); });
            settingsBackBtn.addEventListener('click', () => { playSound('buttonClick'); showScreen('homepage-screen'); });
            customizeBackBtn.addEventListener('click', () => { playSound('buttonClick'); showScreen('homepage-screen'); });

            restartButton.addEventListener('click', () => { playSound('buttonClick'); startGame(1); });
            menuButton.addEventListener('click', () => { playSound('buttonClick'); showMenu(); });
            nextLevelButton.addEventListener('click', () => { playSound('buttonClick'); nextLevel(); });
            menuLevelButton.addEventListener('click', () => { playSound('buttonClick'); showMenu(); });

            menuButtonNav.addEventListener('click', async () => {
                playSound('buttonClick');
                const confirmExit = await showMessageBox("Are you sure you want to quit the current game?", "confirm");
                if (confirmExit) {
                    showScreen('homepage-screen');
                }
            });
            shopButtonNav.addEventListener('click', () => { playSound('buttonClick'); showScreen('shop-screen'); });
            settingsButtonNav.addEventListener('click', () => { playSound('buttonClick'); showScreen('settings-screen'); });

            buyCrownBtn.addEventListener('click', () => { playSound('buttonClick'); buyCustomizationItem('fancy-hat'); });
            buyWingsBtn.addEventListener('click', () => { playSound('buttonClick'); buyCustomizationItem('shiny-sword'); });


            volumeSlider.addEventListener('input', (event) => {
                gameState.settings.musicVolume = parseFloat(event.target.value);
                updateVolume();
                saveGameState();
            });

            sfxVolumeSlider.addEventListener('input', (event) => {
                gameState.settings.sfxVolume = parseFloat(event.target.value);
                updateVolume();
                saveGameState();
            });

            darkModeToggle.addEventListener('change', toggleDarkMode);
            difficultySelect.addEventListener('change', updateDifficulty);
            soundSelect.addEventListener('change', updateSound);
            controlsSelect.addEventListener('change', updateControls);

            // Keyboard input for game
            document.addEventListener('keydown', (e) => {
                if (gameState.currentScreen === 'game' || gameState.currentScreen === 'transitioning') { // Allow controls during transition for seamless play
                    if (e.key === 'ArrowLeft') gameState.keys.ArrowLeft = true;
                    if (e.key === 'ArrowRight') gameState.keys.ArrowRight = true;
                    if (e.key === 'ArrowUp' || e.key === ' ') gameState.keys.ArrowUp = true;
                    if (e.key === 'ArrowDown') gameState.keys.ArrowDown = true;

                    if (e.key === 'a') gameState.keys.a = true;
                    if (e.key === 'd') gameState.keys.d = true;
                    if (e.key === 'w') gameState.keys.w = true;
                    if (e.key === 's') gameState.keys.s = true;

                    // Debug keys (Only active during PLAYING state for safety)
                    if (gameState.currentScreen === 'game') {
                        if (e.key === '1') {
                            gameState.currentLevel = 1;
                            initGame(); // Reload level
                        }
                        if (e.key === '2') {
                            gameState.currentLevel = 2;
                            initGame(); // Reload level
                        }
                        if (e.key === '3') { // Debug key for Level 3
                            gameState.currentLevel = 3;
                            initGame();
                        }
                        if (e.key === 'q') { // Quick coin cheat
                            gameState.honeyJars.push({ collected: true });
                            gameState.honeyJars.push({ collected: true });
                            gameState.honeyJars.push({ collected: true });
                            gameState.honeyJars.push({ collected: true });
                            gameState.honeyJars.push({ collected: true });
                            updateGameUI();
                        }
                        if (e.key === 'L') { // Lose a life cheat
                            gameState.lives--;
                            gameState.player.x = 50; gameState.player.y = gameState.ground.y - gameState.player.height;
                            if (gameState.lives <= 0) gameOver();
                            updateGameUI();
                        }
                        if (e.key === 'i') { // Toggle invincibility
                            gameState.playerUpgrades.invincible = !gameState.playerUpgrades.invincible;
                            if (gameState.playerUpgrades.invincible) gameState.playerUpgrades.invincibleEndTime = Date.now() + 999999; // Long duration
                            else gameState.playerUpgrades.invincibleEndTime = 0;
                            updatePowerupIndicator();
                        }
                        if (e.key === 'p') { // Toggle speed boost (using 'p' to avoid conflict with 's' for WASD)
                            gameState.playerUpgrades.speed = !gameState.playerUpgrades.speed;
                            if (gameState.playerUpgrades.speed) {
                                gameState.player.speed = gameState.player.baseSpeed * 1.5;
                                gameState.playerUpgrades.speedEndTime = Date.now() + 999999;
                            } else {
                                gameState.player.speed = gameState.player.baseSpeed;
                                gameState.playerUpgrades.speedEndTime = 0;
                            }
                            updatePowerupIndicator();
                        }
                    }
                }
            });

            document.addEventListener('keyup', (e) => {
                if (gameState.currentScreen === 'game' || gameState.currentScreen === 'transitioning') {
                    if (e.key === 'ArrowLeft') gameState.keys.ArrowLeft = false;
                    if (e.key === 'ArrowRight') gameState.keys.ArrowRight = false;
                    if (e.key === 'ArrowUp' || e.key === ' ') gameState.keys.ArrowUp = false;
                    if (e.key === 'ArrowDown') gameState.keys.ArrowDown = false;

                    if (e.key === 'a') gameState.keys.a = false;
                    if (e.key === 'd') gameState.keys.d = false;
                    if (e.key === 'w') gameState.keys.w = false;
                    if (e.key === 's') gameState.keys.s = false;
                }
            });

            // --- Initial Setup ---
            loadAudio();
            loadGameState(); // Load saved state first
            playerImageInstance = createPlayerImageBitmap(); // Generate initial player image based on loaded state

            // Add some bounce animation to the title
            const title = document.querySelector('#homepage-screen h1');
            if (title) { // Check if title exists before adding class
                title.classList.add('bounce');
            }

            // Set initial difficulty indicator based on loaded state
            updateDifficulty();
            // Render empty leaderboard
            renderLeaderboard();
            // Render level selection buttons
            renderLevelSelection();

            showScreen('homepage-screen'); // Start on the homepage
        };
    </script>
</body>
</html>
